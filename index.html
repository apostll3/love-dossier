<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–î–æ—Å—å—î –∫–æ—Ö–∞–Ω–æ—ó –ª—é–¥–∏–Ω–∏</title>
<!--
  üìù –Ü–ù–°–¢–†–£–ö–¶–Ü–Ø –ó –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø –¢–ï–ö–°–¢–£:
  
  –ü—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ –ø–æ–ª—ñ–≤ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è:
  
  **–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç** –∞–±–æ __–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç__ ‚Üí –∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç (—Å–∏–Ω—ñ–π –∫–æ–ª—ñ—Ä)
  *–∫—É—Ä—Å–∏–≤* –∞–±–æ _–∫—É—Ä—Å–∏–≤_ ‚Üí –∫—É—Ä—Å–∏–≤
  ~~–∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π~~ ‚Üí –∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π —Ç–µ–∫—Å—Ç
  [—Ç–µ–∫—Å—Ç –ø–æ—Å–∏–ª–∞–Ω–Ω—è](https://example.com) ‚Üí –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
  
  üé® –®–í–ò–î–ö–ï –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø:
  1. –í–∏–¥—ñ–ª—ñ—Ç—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª—ñ input –∞–±–æ textarea
  2. –ó'—è–≤–∏—Ç—å—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –∑ –∫–Ω–æ–ø–∫–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
  3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω—É –∫–Ω–æ–ø–∫—É –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –≥–∞—Ä—è—á—ñ –∫–ª–∞–≤—ñ—à—ñ:
     ‚Ä¢ Ctrl+B - –∂–∏—Ä–Ω–∏–π
     ‚Ä¢ Ctrl+I - –∫—É—Ä—Å–∏–≤
     ‚Ä¢ Ctrl+K - –ø–æ—Å–∏–ª–∞–Ω–Ω—è
  
  –ü—Ä–∏–∫–ª–∞–¥: "–õ—é–±–∏—Ç—å **—à–æ–∫–æ–ª–∞–¥** —ñ *–∫–∞–≤—É*, –∞–ª–µ ~~–Ω–µ –ª—é–±–∏—Ç—å~~ —á–∞–π. [–£–ª—é–±–ª–µ–Ω–∏–π —Å–∞–π—Ç](https://example.com)"
  
  –¶–µ –ø—Ä–∞—Ü—é—î –≤ —É—Å—ñ—Ö —Ç–∏–ø–∞—Ö –ø–æ–ª—ñ–≤: text, textarea, tags, —ñ –Ω–∞–≤—ñ—Ç—å —É –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –ø–æ–ª—è—Ö!
-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<!-- Google API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #0f172a;
  --text-muted: #64748b;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  --radius: 0.75rem;
  --radius-sm: 0.5rem;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 1.5rem;
  color: var(--text);
  line-height: 1.6;
}

/* –ó–∞–±–æ—Ä–æ–Ω–∞ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è UI –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ */
button,
.btn,
.header,
.sidebar,
.category-item,
.field-label,
.field-meta,
.badge,
.chip,
.modal-header,
.modal-footer,
.content-title,
.content-actions,
.filters-toggle-btn,
.filters-dropdown-label,
.progress-bar-text,
label,
.header-title,
.header-icon,
.sidebar-title,
.empty-state-icon,
.toast,
i,
.field-controls {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

/* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É */
input,
textarea,
.field-value,
.nested-subcategory,
.search-input {
  user-select: text;
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

/* Header */
.header {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Header top row */
.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
}

.header-main-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
  position: relative;
}

/* Header Menu Button */
.header-menu-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.875rem;
  border: 2px solid var(--border);
  background: white;
  color: var(--text);
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.header-menu-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.header-menu-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
  box-shadow: var(--shadow);
}

.header-menu-btn i {
  font-size: 0.875rem;
}

/* Header Menu Dropdown */
.header-menu-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 0.5rem);
  right: 0;
  background: white;
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  padding: 0.5rem;
  z-index: 1000;
  min-width: 200px;
}

.header-menu-dropdown.active {
  display: flex;
  flex-direction: column;
  animation: dropdownSlide 0.2s ease;
}

.header-menu-dropdown.closing {
  display: flex;
  flex-direction: column;
  animation: dropdownSlideOut 0.2s ease forwards;
  pointer-events: none;
}

.header-menu-dropdown .btn {
  width: 100%;
  justify-content: flex-start;
  text-align: left;
  border-radius: var(--radius-sm);
  padding: 0.625rem 0.875rem;
  font-size: 0.875rem;
  background: transparent;
  border: none;
  color: var(--text);
  font-weight: 600;
  transition: all 0.2s ease;
}

.header-menu-dropdown .btn:hover {
  background: var(--bg);
  color: var(--primary);
}

.header-menu-dropdown .btn i {
  width: 1.25rem;
  margin-right: 0.5rem;
}

.header-menu-dropdown .btn.danger:hover {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

/* Header bottom row */
.header-bottom {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 1rem;
  align-items: center;
}

.header-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.25rem;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

/* Search Bar */
.header-search {
  position: relative;
  min-width: 0;
}

.search-input-container {
  position: relative;
  width: 100%;
}

.search-input {
  width: 100%;
  padding: 0.625rem 2.5rem 0.625rem 2.5rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
  background: white;
  transition: all 0.2s ease;
  font-family: inherit;
}

.search-input:hover {
  border-color: #cbd5e1;
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.search-icon {
  position: absolute;
  left: 0.875rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 0.875rem;
  pointer-events: none;
}

.search-input:focus ~ .search-icon {
  color: var(--primary);
}

.search-clear-btn {
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  font-size: 1rem;
}

.search-clear-btn.visible {
  display: flex;
}

.search-clear-btn:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--danger);
}

/* Progress Bar */
.header-progress {
  position: relative;
  display: flex;
  align-items: center;
  gap: 1rem;
  white-space: nowrap;
}

.progress-bar-container {
  width: 120px;
  height: 8px;
  background: var(--border);
  border-radius: 999px;
  overflow: hidden;
  position: relative;
  cursor: help;
  flex-shrink: 0;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-dark));
  border-radius: 999px;
  transition: width 0.3s ease;
  box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
}

.progress-bar-text {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 600;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Search Highlight */
.search-highlight {
  background: #fef08a;
  color: #854d0e;
  font-weight: 600;
  padding: 0;
  border-radius: 2px;
}

/* Search Badge */
.search-result-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary);
  padding: 0.125rem 0.5rem;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

/* Fill Filter */
.fill-filter {
  display: inline-flex;
  gap: 0.25rem;
  background: var(--bg);
  padding: 0.25rem;
  border-radius: var(--radius-sm);
  border: 2px solid var(--border);
}

.fill-filter-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
  border: none;
  background: transparent;
  color: var(--text-muted);
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.fill-filter-btn:hover {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary);
}

.fill-filter-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.fill-filter-btn i {
  font-size: 0.875rem;
}

/* Importance Filter */
.importance-filter {
  display: inline-flex;
  gap: 0.25rem;
}

.importance-filter-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
  border: 2px solid var(--border);
  background: var(--bg);
  color: var(--text-muted);
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.importance-filter-btn:hover {
  border-color: var(--text-muted);
  transform: translateY(-1px);
}

.importance-filter-btn.active.high {
  background: var(--danger);
  border-color: var(--danger);
  color: white;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.importance-filter-btn.active.medium {
  background: var(--warning);
  border-color: var(--warning);
  color: white;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.importance-filter-btn.active.low {
  background: var(--success);
  border-color: var(--success);
  color: white;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.importance-filter-btn i {
  font-size: 0.875rem;
}

/* Main layout */
.main-grid {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 1.5rem;
  align-items: start;
}


/* Sidebar */
.sidebar {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow-lg);
  position: sticky;
  top: 1.5rem;
  max-height: calc(100vh - 3rem);
  overflow-y: auto;
  transition: all 0.3s ease;
}

/* –ö–Ω–æ–ø–∫–∞ toggle (—Ç—ñ–ª—å–∫–∏ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö) */
.sidebar-toggle-btn {
  display: none;
  width: 100%;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, #4f46e5, #3730a3);
  color: white;
  border: none;
  padding: 0.875rem 1rem;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.9375rem;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  position: relative;
  overflow: hidden;
}

.sidebar-toggle-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sidebar-toggle-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
  background: linear-gradient(135deg, #5b52e8, #4338ca);
}

.sidebar-toggle-btn:hover::before {
  opacity: 1;
}

.sidebar-toggle-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.sidebar-toggle-btn .sidebar-toggle-icon {
  font-size: 1.125rem;
  opacity: 0.9;
}

.sidebar-toggle-btn .sidebar-toggle-arrow {
  margin-left: auto;
  font-size: 0.875rem;
  transition: transform 0.3s ease;
}

.sidebar-toggle-btn.active .sidebar-toggle-arrow {
  transform: rotate(180deg);
}

.sidebar-toggle-btn span {
  font-weight: 600;
  letter-spacing: 0.02em;
  flex: 1;
  text-align: left;
}

.sidebar-title {
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin-bottom: 1rem;
}

.category-nav {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-bottom: 1rem;
}

/* –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó */
.btn-add-category {
  width: 100%;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  padding: 0.875rem 1rem;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
  position: relative;
  overflow: hidden;
}

.btn-add-category::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.btn-add-category:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
  background: linear-gradient(135deg, #14c992, #06a372);
}

.btn-add-category:hover::before {
  opacity: 1;
}

.btn-add-category:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
}

.btn-add-category i {
  font-size: 1rem;
}

.btn-add-category span {
  font-weight: 600;
  letter-spacing: 0.01em;
}

.category-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  background: var(--bg);
}

.category-item:hover {
  background: rgba(99, 102, 241, 0.1);
  border-color: var(--primary);
}

.category-item.active {
  background: var(--primary);
  color: white;
  font-weight: 600;
}

.category-icon {
  width: 2rem;
  height: 2rem;
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.category-item.active .category-icon {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.category-label {
  flex: 1;
  font-size: 0.9rem;
}

.category-count {
  font-size: 0.75rem;
  background: rgba(0, 0, 0, 0.1);
  padding: 0.125rem 0.5rem;
  border-radius: 999px;
  font-weight: 600;
}

.category-item.active .category-count {
  background: rgba(255, 255, 255, 0.2);
}

/* Content area */
.content {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow-lg);
  min-height: 400px;
  position: relative;
}

.content-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border);
  gap: 1rem;
  flex-wrap: wrap;
}

.content-title {
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.content-title i {
  color: var(--primary);
}

.content-title span {
  line-height: 1;
}

.content-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  align-items: center;
  position: relative;
}

/* Filters Toggle */
.filters-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.875rem;
  border: 2px solid var(--border);
  background: white;
  color: var(--text);
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.filters-toggle-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.filters-toggle-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
  box-shadow: var(--shadow);
}

.filters-toggle-btn i {
  font-size: 0.875rem;
}

/* Badge –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ */
.filters-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: var(--danger);
  color: white;
  border-radius: 999px;
  width: 18px;
  height: 18px;
  font-size: 0.65rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
}

.filters-container {
  display: none;
}

.filters-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 0.5rem;
  background: white;
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  padding: 1.25rem;
  z-index: 1000;
  max-width: 328px;
  width: max-content;
}

.filters-dropdown.active {
  display: flex;
  flex-direction: column;
  animation: dropdownSlide 0.2s ease;
}

.filters-dropdown.closing {
  display: flex;
  flex-direction: column;
  animation: dropdownSlideOut 0.2s ease forwards;
  pointer-events: none;
}

@keyframes dropdownSlide {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes dropdownSlideOut {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-10px);
  }
}

.filters-dropdown-section {
  margin-bottom: 1.25rem;
}

.filters-dropdown-section:last-child {
  margin-bottom: 0;
}

.filters-dropdown-label {
  font-size: 0.8125rem;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--primary);
  margin-bottom: 0.75rem;
  letter-spacing: 0.05em;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filters-dropdown-label i {
  font-size: 1rem;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ dropdown */
.filters-dropdown .fill-filter,
.filters-dropdown .importance-filter {
  display: flex;
  gap: 0.375rem;
  flex-wrap: wrap;
}

.filters-dropdown .fill-filter-btn,
.filters-dropdown .importance-filter-btn {
  flex: 1 1 auto;
  min-width: fit-content;
  justify-content: center;
  padding: 0.625rem 0.625rem;
  font-size: 0.8125rem;
}

.filters-dropdown .fill-filter-btn span,
.filters-dropdown .importance-filter-btn span {
  white-space: nowrap;
}

/* Fields grid */
.fields-grid {
  display: grid;
  gap: 1rem;
}

.field-card {
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem;
  transition: all 0.2s;
}

.field-card:hover {
  border-color: var(--primary);
  box-shadow: var(--shadow);
}

.field-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  gap: 1rem;
  margin-bottom: 0.75rem;
}

.field-info {
  flex: 1;
}

.field-label {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.field-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.field-controls {
  display: flex;
  gap: 0.25rem;
  position: relative;
}

/* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö) */
.field-controls-menu-btn {
  display: none !important;
}

@media (max-width: 500px) {
  .field-controls-menu-btn {
    display: flex !important;
  }
}

/* Popup –º–µ–Ω—é –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
.field-controls-popup {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 0.5rem;
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 0.5rem;
  z-index: 100;
  min-width: 150px;
}

.field-controls-popup.active {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.field-controls-popup .btn {
  width: 100%;
  justify-content: flex-start;
}

.field-value {
  padding: 0.75rem;
  background: white;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  min-height: 3rem;
  display: flex;
  align-items: center;
  white-space: pre-wrap;
  word-wrap: break-word;
  flex-wrap: wrap;
}

.field-value.empty {
  color: var(--text-muted);
  font-style: italic;
}

.field-value strong,
.field-value b {
  font-weight: 700;
  color: var(--primary);
}

.field-value em,
.field-value i {
  font-style: italic;
  color: var(--text);
}

.field-value u {
  text-decoration: underline;
}

.field-value del {
  text-decoration: line-through;
  opacity: 0.7;
}

.field-value a {
  color: var(--primary);
  text-decoration: underline;
  font-weight: 600;
  transition: all 0.2s;
}

.field-value a:hover {
  color: var(--primary-dark);
  text-decoration: none;
}

/* Nested fields */
.nested-container {
  display: grid;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.nested-category {
  background: white;
  border-radius: var(--radius-sm);
  padding: 1rem;
  border: 1px solid var(--border);
}

.nested-category-title {
  font-weight: 600;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
}

.nested-subcategory {
  margin-top: 0.75rem;
}

.nested-subcategory:first-child {
  margin-top: 0;
}

.nested-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.chips-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.chip {
  background: var(--primary);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  font-size: 0.875rem;
  font-weight: 500;
}

.chip em {color:#e2e8f0}

.chip strong,
.chip b {
  font-weight: 700;
  color: white;
}

.chip em,
.chip i {
  font-style: italic;
}

.chip del {
  text-decoration: line-through;
  opacity: 0.8;
}

.chip a {
  color: white;
  text-decoration: underline;
  font-weight: 600;
}

.chip a:hover {
  opacity: 0.9;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: var(--radius-sm);
  border: none;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-secondary {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.8rem;
}

.btn-icon {
  padding: 0.5rem;
  aspect-ratio: 1;
}

/* Badges */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.625rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge i {
  font-size: 0.875rem;
}

.badge-high {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.badge-medium {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
}

.badge-low {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

/* Modal */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
  transition: opacity 0.2s ease;
  opacity: 0;
}

.modal-backdrop.active,
.modal-backdrop.closing {
  display: flex;
}

.modal-backdrop.active {
  opacity: 1;
}

.modal {
  background: var(--card);
  border-radius: 12px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.05);
  transform: scale(0.95);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}

.modal-large {
  max-width: 900px;
}

.modal-small {
  max-width: 400px;
}

.modal-backdrop.active .modal {
  transform: scale(1) translateY(0);
  opacity: 1;
}

.modal-backdrop.closing .modal {
  transform: scale(0.9) translateY(20px);
  opacity: 0;
}

.modal-backdrop.closing {
  opacity: 0;
}

.modal-header {
  padding: 1.25rem 1.5rem;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.03), rgba(99, 102, 241, 0.01));
  border-bottom: 1px solid rgba(99, 102, 241, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 700;
  display: flex;
  line-height: 1.3;
  align-items: center;
  gap: 0.875rem;
  color: var(--text);
  flex: 1;
}

.modal-title-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2.75rem;
  height: 2.75rem;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border-radius: 12px;
  font-size: 1.25rem;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35);
  flex-shrink: 0;
  transition: all 0.3s ease;
}

.modal-title-icon:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.45);
}

.modal-title span {
  line-height: 1.3;
}

.modal-close-btn {
  width: 2rem;
  height: 2rem;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border: none;
  color: white;
  transition: all 0.3s ease;
  flex-shrink: 0;
  box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
}

.modal-close-btn:active {
  transform: scale(0.95);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
}

.modal-close-btn i {
  font-size: 1rem;
}

.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
  background: var(--card);
}

.modal-footer {
  padding: 1.25rem 1.5rem;
  background: var(--bg);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
}

/* Form elements */
.form-group {
  margin-bottom: 1.25rem;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.625rem;
  font-size: 0.875rem;
  color: var(--text);
  letter-spacing: 0.01em;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text);
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 1.125rem;
  height: 1.125rem;
}

.form-input,
.form-textarea,
.form-select {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 0.9375rem;
  background: white;
  transition: all 0.2s ease;
  font-family: inherit;
}

.form-select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding-right: 2.75rem;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.875rem center;
  background-size: 20px;
  cursor: pointer;
  position: relative;
}

.form-input:hover,
.form-textarea:hover {
  border-color: #cbd5e1;
}

.form-select:hover {
  border-color: #cbd5e1;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
}

.form-select:active {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 12.5L10 7.5L15 12.5' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  background: white;
}

.form-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  background-color: white;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 12.5L10 7.5L15 12.5' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
}

.form-textarea {
  resize: vertical;
  min-height: 120px;
  line-height: 1.6;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-checkbox {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 0.75rem;
  cursor: pointer;
  user-select: none;
}

.form-checkbox input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 1.25rem;
  height: 1.25rem;
  border: 2px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  transition: all 0.2s ease;
  background: white;
  flex-shrink: 0;
}

.form-checkbox input[type="checkbox"]:hover {
  border-color: var(--primary);
  background: rgba(99, 102, 241, 0.05);
}

.form-checkbox input[type="checkbox"]:checked {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border-color: var(--primary);
}

.form-checkbox input[type="checkbox"]:checked::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) rotate(45deg);
  width: 5px;
  height: 9px;
  border: solid white;
  border-width: 0 2px 2px 0;
}

.form-checkbox input[type="checkbox"]:focus {
  outline: none;
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.form-checkbox label {
  cursor: pointer;
  font-size: 0.9375rem;
  color: var(--text);
  line-height: 1.5;
}

/* Custom Select Dropdown */
.custom-select {
  position: relative;
  width: 100%;
}

.custom-select-trigger {
  width: 100%;
  padding: 0.875rem 1rem;
  padding-right: 2.75rem;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 0.9375rem;
  background: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.625rem;
  transition: all 0.2s ease;
  user-select: none;
}

.custom-select-trigger:hover {
  border-color: #cbd5e1;
}

.custom-select.active .custom-select-trigger {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.custom-select-trigger::after {
  content: '';
  position: absolute;
  right: 0.875rem;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
  transition: transform 0.2s ease;
}

.custom-select.active .custom-select-trigger::after {
  transform: translateY(-50%) rotate(180deg);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
}

.custom-select-icon {
  font-size: 1rem;
  color: var(--primary);
  flex-shrink: 0;
}

.custom-select-text {
  flex: 1;
  color: var(--text);
}

.custom-select-dropdown {
  position: fixed;
  background: white;
  border: 2px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  max-height: 300px;
  overflow-y: auto;
  z-index: 10000;
  opacity: 0;
  transform: translateY(-10px);
  pointer-events: none;
  transition: all 0.2s ease;
}

/* –ö–∞—Å—Ç–æ–º–Ω–∏–π scrollbar –¥–ª—è dropdown */
.custom-select-dropdown::-webkit-scrollbar {
  width: 8px;
}

.custom-select-dropdown::-webkit-scrollbar-track {
  background: var(--bg);
  border-radius: 0 6px 6px 0;
}

.custom-select-dropdown::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border-radius: 4px;
  transition: background 0.2s ease;
}

.custom-select-dropdown::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--primary-dark), #3730a3);
}

/* Firefox scrollbar */
.custom-select-dropdown {
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--bg);
}

.custom-select.active .custom-select-dropdown,
.custom-select-dropdown.active {
  opacity: 1;
  transform: translateY(0);
  pointer-events: all;
}

.custom-select-option {
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  gap: 0.625rem;
  cursor: pointer;
  transition: all 0.15s ease;
  border-bottom: 1px solid var(--border);
}

.custom-select-option:last-child {
  border-bottom: none;
}

.custom-select-option:hover {
  background: rgba(99, 102, 241, 0.05);
}

.custom-select-option.selected {
  background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
  color: var(--primary);
  font-weight: 600;
}

.custom-select-option-icon {
  font-size: 1rem;
  color: var(--primary);
  flex-shrink: 0;
  width: 1.25rem;
  text-align: center;
}

.custom-select-option-text {
  flex: 1;
}

/* Format Menu */
.format-menu {
  position: absolute;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-lg);
  padding: 0.5rem;
  display: none;
  z-index: 1500;
  gap: 0.25rem;
  flex-direction: row;
}

.format-menu.active {
  display: flex;
}

.format-menu-btn {
  padding: 0.5rem 0.75rem;
  border: none;
  background: var(--bg);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.format-menu-btn:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-1px);
}

.format-menu-btn i {
  font-size: 0.875rem;
}

/* Sync Status */
.sync-status {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  font-weight: 600;
  transition: all 0.2s ease;
}

.sync-status.synced {
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
}

.sync-status.syncing {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
}

.sync-status.error {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.sync-status.offline {
  background: var(--bg);
  color: var(--text-muted);
}

.sync-status.local {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary);
}

.sync-status i {
  font-size: 0.875rem;
}

/* Instruction Block */
.instruction-block {
  background: var(--bg);
  border-left: 4px solid var(--primary);
  padding: 1rem;
  border-radius: var(--radius-sm);
  margin: 1rem 0;
  font-size: 0.875rem;
  line-height: 1.6;
}

.instruction-block h4 {
  color: var(--primary);
  margin-bottom: 0.75rem;
  font-size: 0.9375rem;
}

.instruction-block ol {
  margin-left: 1.5rem;
  margin-top: 0.5rem;
}

.instruction-block li {
  margin-bottom: 0.5rem;
}

.instruction-block code {
  background: rgba(99, 102, 241, 0.1);
  padding: 0.125rem 0.375rem;
  border-radius: 3px;
  font-family: monospace;
  font-size: 0.8125rem;
}

.instruction-toggle {
  cursor: pointer;
  color: var(--primary);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  user-select: none;
}

.instruction-toggle:hover {
  color: var(--primary-dark);
}

.instruction-toggle i {
  transition: transform 0.2s ease;
}

.instruction-toggle.expanded i {
  transform: rotate(180deg);
}

.instruction-content {
  display: none;
}

.instruction-content.show {
  display: block;
}

/* Password Input Group */
.password-input-group {
  position: relative;
}

.password-toggle {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-muted);
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
}

.password-toggle:hover {
  color: var(--primary);
}

/* Settings Section */
.settings-section {
  margin-bottom: 1.5rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.settings-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.settings-section-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.settings-section-title i {
  color: var(--primary);
}

.radio-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.radio-option {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.75rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s ease;
}

.radio-option:hover {
  border-color: var(--primary);
  background: rgba(99, 102, 241, 0.05);
}

.radio-option input[type="radio"] {
  margin-top: 0.25rem;
  cursor: pointer;
}

.radio-option-content {
  flex: 1;
}

.radio-option-label {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.25rem;
  display: block;
}

.radio-option-desc {
  font-size: 0.8125rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.radio-option input[type="radio"]:checked ~ .radio-option-content .radio-option-label {
  color: var(--primary);
}

.sync-settings-group {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;
  padding: 1rem;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.sync-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.security-notice {
  background: rgba(16, 185, 129, 0.1);
  border-left: 4px solid #10b981;
  padding: 1rem;
  border-radius: var(--radius-sm);
  margin-top: 1rem;
}

.security-notice-title {
  font-weight: 600;
  color: #10b981;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.security-notice ul {
  margin-left: 1.5rem;
  margin-top: 0.5rem;
  font-size: 0.8125rem;
  color: var(--text-muted);
  line-height: 1.6;
}

.sync-stats {
  display: flex;
  gap: 1.5rem;
  padding: 1rem;
  background: var(--bg);
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
}

.sync-stat-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.sync-stat-label {
  color: var(--text-muted);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sync-stat-value {
  font-weight: 600;
  color: var(--text);
}

/* Toast */
.toast-container {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toast {
  background: var(--text);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  min-width: 300px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  opacity: 0;
  transform: translateX(400px);
}

.toast.show {
  animation: slideIn 0.3s ease forwards;
}

/* –¢–∏–ø–∏ toast –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
.toast-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border-left: 4px solid #047857;
}

.toast-error {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border-left: 4px solid #b91c1c;
  font-weight: 600;
}

.toast-warning {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  border-left: 4px solid #b45309;
  color: #ffffff;
}

.toast-info {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border-left: 4px solid #1d4ed8;
}

.toast:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-xl);
}

.toast i {
  font-size: 1.25rem;
  flex-shrink: 0;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast.removing {
  animation: slideOut 0.3s ease forwards;
}

@keyframes slideOut {
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 1.125rem;
  margin-bottom: 0.5rem;
}

/* Utilities */
.hidden {
  display: none !important;
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg);
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Responsive */
@media (max-width: 1024px) {
  /* –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É toggle –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö —ñ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
  .sidebar-toggle-btn {
    display: flex;
  }

  /* Sidebar –∫–æ–Ω—Ç–µ–Ω—Ç –∑–≥–æ—Ä—Ç–∞—î—Ç—å—Å—è */
  .sidebar.collapsed .category-nav,
  .sidebar.collapsed .sidebar-title,
  .sidebar.collapsed > .btn {
    display: none;
  }

  .sidebar.collapsed {
    padding: 0;
    background: transparent;
    box-shadow: none;
  }

  .sidebar {
    position: static;
    max-height: none;
  }

  .sidebar.collapsed .sidebar-toggle-btn {
    margin-bottom: 0;
  }
  
  /* Main grid —Å—Ç–∞—î –æ–¥–Ω–æ–∫–æ–ª–æ–Ω–∫–æ–≤–∏–º */
  .main-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  /* –ù–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö dropdown –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
  .filters-dropdown {
    right: auto;
    left: 0;
    width: calc(100vw - 4rem);
    max-width: none;
  }
  
  .content-actions {
    position: relative;
    width: 100%;
  }
  
  /* –ö–Ω–æ–ø–∫–∏ –Ω–∞ –ø–æ–≤–Ω—É —à–∏—Ä–∏–Ω—É */
  .content-actions > .btn,
  .filters-toggle-btn {
    flex: 1;
  }
}

@media (max-width: 768px) {
  body {
    padding: 1rem;
  }

  .header {
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .header-top {
    flex-direction: column;
    align-items: stretch;
  }
  
  .header-title {
    font-size: 1.25rem;
  }
  
  .header-main-actions {
    width: 100%;
  }
  
  .header-main-actions .btn {
    flex: 1;
  }
  
  .header-bottom {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .header-progress {
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }
  
  .progress-bar-container {
    width: 100%;
  }
  
  .progress-bar-text {
    text-align: center;
  }
  
  .header-menu-dropdown {
    right: auto;
    left: 0;
    width: calc(100vw - 4rem);
    max-width: none;
  }
  .main-grid {
    gap: 1rem;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .sidebar {
    position: static;
    max-height: none;
  }

  .toast {
    min-width: unset;
    width: calc(100vw - 2rem);
  }

  /* Modal –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
  .modal {
    max-width: calc(100vw - 2rem);
    border-radius: 12px;
  }

  .modal-header {
    padding: 1.25rem;
  }

  .modal-title {
    font-size: 1.25rem;
  }

  .modal-title-icon {
    width: 2.25rem;
    height: 2.25rem;
    font-size: 1rem;
  }

  .modal-body {
    padding: 1.25rem;
  }

  .modal-footer {
    padding: 1rem 1.25rem;
    flex-direction: column-reverse;
  }

  .modal-footer .btn {
    width: 100%;
  }

  .content-actions .btn {
    padding: 0.5rem;
  }
  .content, .sidebar {
    padding: 1rem;
  }

}

@media (max-width: 500px) {

  .content-title {
    font-size: 18px;
  }
}

@media (max-width: 500px) {
  /* –•–æ–≤–∞—î–º–æ –≤—Å—ñ –∫–Ω–æ–ø–∫–∏ –∫—Ä—ñ–º –º–µ–Ω—é */
  .field-controls > .btn:not(.field-controls-menu-btn) {
    display: none !important;
  }
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <header class="header">
    <!-- Top Row: Title + Main Actions -->
    <div class="header-top">
      <div class="header-title">
        <div class="header-icon">
          <i class="fas fa-heart"></i>
        </div>
        <span>–î–æ—Å—å—î –∫–æ—Ö–∞–Ω–æ—ó –ª—é–¥–∏–Ω–∏</span>
      </div>
      
      <div class="header-main-actions">
        <div class="sync-status local" id="syncStatus" title="–†–µ–∂–∏–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è">
          <i class="fas fa-laptop"></i>
          <span>Local —Ä–µ–∂–∏–º</span>
        </div>
        
        <button class="btn btn-secondary btn-sm" id="btnSave">
          <i class="fas fa-save"></i>
          <span>–ó–±–µ—Ä–µ–≥—Ç–∏</span>
        </button>
        
        <button class="btn btn-primary btn-sm" id="btnAddField">
          <i class="fas fa-plus"></i>
          <span>–î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</span>
        </button>
        
        <button class="header-menu-btn" onclick="App.toggleHeaderMenu()" id="headerMenuBtn">
          <i class="fas fa-ellipsis-h"></i>
          <span>–ë—ñ–ª—å—à–µ</span>
        </button>
        
        <div class="header-menu-dropdown" id="headerMenuDropdown">
          <button class="btn" id="btnSync">
            <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
          </button>
          <button class="btn" id="btnExport">
            <i class="fas fa-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
          </button>
          <button class="btn" id="btnImport">
            <i class="fas fa-upload"></i> –Ü–º–ø–æ—Ä—Ç
          </button>
          <button class="btn danger" id="btnClear">
            <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç–∏
          </button>
        </div>
      </div>
    </div>
    
    <!-- Bottom Row: Search + Progress -->
    <div class="header-bottom">
      <div class="header-search" id="headerSearch">
        <div class="search-input-container">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="–ü–æ—à—É–∫ –ø–æ –≤—Å—ñ—Ö –ø–æ–ª—è—Ö..."
            autocomplete="off"
          />
          <i class="fas fa-search search-icon"></i>
          <button class="search-clear-btn" id="searchClearBtn" title="–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ—à—É–∫">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="header-progress" id="headerProgress">
        <div class="progress-bar-container" title="–ü—Ä–æ–≥—Ä–µ—Å –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è">
          <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
        </div>
        <div class="progress-bar-text" id="progressBarText">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</div>
      </div>
    </div>
    
    <input type="file" id="fileInput" accept=".json" class="hidden">
  </header>

  <!-- Main Grid -->
  <div class="main-grid">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <button class="sidebar-toggle-btn" id="sidebarToggle">
        <i class="fas fa-layer-group sidebar-toggle-icon"></i>
        <span>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</span>
        <i class="fas fa-chevron-down sidebar-toggle-arrow"></i>
      </button>
      <div class="sidebar-title">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</div>
      <nav class="category-nav" id="categoryNav">
        <!-- Categories will be rendered here -->
      </nav>
      <button class="btn btn-add-category" id="btnAddCategory">
        <i class="fas fa-folder-plus"></i>
        <span>–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</span>
      </button>
    </aside>

    <!-- Content -->
    <main class="content">
      <div class="content-header">
        <div class="content-title" id="contentTitle">
          <i class="fas fa-folder"></i>
          <span>–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</span>
        </div>
        <div class="content-actions" id="contentActions">
          <!-- Dynamic actions will appear here -->
        </div>
      </div>
      <div id="contentBody">
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-hand-pointer"></i>
          </div>
          <div class="empty-state-text">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑–ª—ñ–≤–∞</div>
          <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø–æ–ª—è</p>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-edit modal-title-icon" id="modalTitleIcon"></i>
        <span id="modalTitle">–ú–æ–¥–∞–ª–∫–∞</span>
      </div>
      <button class="btn btn-icon btn-secondary btn-sm modal-close-btn" id="modalClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="modalCancel">
        <i class="fas fa-times"></i>
        <span>–°–∫–∞—Å—É–≤–∞—Ç–∏</span>
      </button>
      <button class="btn btn-primary" id="modalSave">
        <i class="fas fa-check"></i>
        <span>–ó–±–µ—Ä–µ–≥—Ç–∏</span>
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Format Menu -->
<div class="format-menu" id="formatMenu">
  <button class="format-menu-btn" data-format="bold" title="–ñ–∏—Ä–Ω–∏–π (Ctrl+B)">
    <i class="fas fa-bold"></i>
  </button>
  <button class="format-menu-btn" data-format="italic" title="–ö—É—Ä—Å–∏–≤ (Ctrl+I)">
    <i class="fas fa-italic"></i>
  </button>
  <button class="format-menu-btn" data-format="strikethrough" title="–ó–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π">
    <i class="fas fa-strikethrough"></i>
  </button>
  <button class="format-menu-btn" data-format="link" title="–ü–æ—Å–∏–ª–∞–Ω–Ω—è (Ctrl+K)">
    <i class="fas fa-link"></i>
  </button>
  <button class="format-menu-btn" data-format="chip" title="Chip">
    <i class="fas fa-tag"></i>
  </button>
</div>

<script>
(function() {
  'use strict';

  // ============= STATE =============
  const State = {
    config: {
      categories: [],
      fields: []
    },
    values: {},
    ui: {
      activeCategory: null,
      lastActiveCategory: null,
      searchActive: false,
      fillFilter: 'all',
      importanceFilters: [], // –º–∞—Å–∏–≤ –∑ 'high', 'medium', 'low'
      modalData: null
    },
    sync: {
      mode: 'localStorage', // 'localStorage' | 'googleSheets' | 'manual'
      googleSheets: {
        enabled: false,
        clientId: '',
        spreadsheetId: '',
        lastSync: null,
        autoSyncEnabled: false,
        autoSyncInterval: 5, // —Ö–≤–∏–ª–∏–Ω–∏
        encryptionEnabled: false,
        encryptionPasswordHash: null // –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
      },
      status: 'local', // 'local' | 'synced' | 'syncing' | 'error' | 'offline'
      statusText: 'Local —Ä–µ–∂–∏–º',
      lastError: null
    }
  };

  // ============= DEFAULT CONFIG =============
  const DefaultConfig = {
    categories: [
      {id: 'base', label: '–ë–∞–∑–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è', icon: 'fa-id-card'},
      {id: 'character', label: '–•–∞—Ä–∞–∫—Ç–µ—Ä', icon: 'fa-brain'},
      {id: 'preferences', label: '–í–ø–æ–¥–æ–±–∞–Ω–Ω—è', icon: 'fa-heart'},
      {id: 'antipreferences', label: '–ê–Ω—Ç–∏–≤–ø–æ–¥–æ–±–∞–Ω–Ω—è', icon: 'fa-heart-broken'},
      {id: 'gifts', label: '–ü–æ–¥–∞—Ä—É–Ω–∫–∏', icon: 'fa-gift'},
      {id: 'psychology', label: '–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è', icon: 'fa-user-circle'},
      {id: 'psych', label: '–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ', icon: 'fa-brain'},
      {id: 'logistics', label: '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞ —Ç–∞ –ø–æ–±—É—Ç', icon: 'fa-map-marked-alt'},
      {id: 'goals', label: '–¶—ñ–ª—ñ —Ç–∞ –º—Ä—ñ—ó', icon: 'fa-star'},
      {id: 'custom', label: '–î–æ–¥–∞—Ç–∫–æ–≤–µ', icon: 'fa-plus-circle'},
      {id: 'communication', label: '–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è', icon: 'fa-comments'},
      {id: 'finance', label: '–§—ñ–Ω–∞–Ω—Å–∏', icon: 'fa-wallet'},
      {id: 'intimacy', label: '–Ü–Ω—Ç–∏–º–Ω—ñ—Å—Ç—å', icon: 'fa-heart', isPrivate: true},
      {id: 'family', label: '–°—ñ–º\'—è', icon: 'fa-users'},
      {id: 'career', label: '–ö–∞—Ä\'—î—Ä–∞', icon: 'fa-briefcase'},
      {id: 'culture', label: '–ö—É–ª—å—Ç—É—Ä–∞', icon: 'fa-globe'}
    ],
    fields: [
      {id: 'fullName', label: '–ü–Ü–ë', type: 'text', category: 'base', importance: 'high', required: true},
      {id: 'dob', label: '–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è', type: 'date', category: 'base', importance: 'high'},
      {id: 'character', label: '–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É', type: 'textarea', category: 'character', importance: 'high'},
      {id: 'dreams', label: '–ú—Ä—ñ—ó —Ç–∞ –±–∞–∂–∞–Ω–Ω—è', type: 'textarea', category: 'character', importance: 'medium'},
      {id: 'likes', label: '–©–æ –ª—é–±–∏—Ç—å', type: 'nested', category: 'preferences', importance: 'high',
        nestedCategories: [
          {id: 'food', label: '–á–∂–∞', subcategories: [
            {id: 'sweet', label: '–°–æ–ª–æ–¥–∫–µ'},
            {id: 'drinks', label: '–ù–∞–ø–æ—ó'}
          ]},
          {id: 'activities', label: '–ó–∞–Ω—è—Ç—Ç—è', subcategories: [
            {id: 'active', label: '–ê–∫—Ç–∏–≤–Ω—ñ'},
            {id: 'calm', label: '–°–ø–æ–∫—ñ–π–Ω—ñ'}
          ]}
        ]
      },
      {id: 'memories', label: '–ü–∞–º\'—è—Ç—å —ñ —Å–ø–æ–≥–∞–¥–∏', type: 'textarea', category: 'character', importance: 'high'},
      {id: 'dislikes', label: '–©–æ –Ω–µ –ª—é–±–∏—Ç—å', type: 'nested', category: 'antipreferences', importance: 'high',
        nestedCategories: [
          {id: 'food', label: '–á–∂–∞', subcategories: [
            {id: 'tastes', label: '–°–º–∞–∫–∏'},
            {id: 'dishes', label: '–°—Ç—Ä–∞–≤–∏'}
          ]},
          {id: 'activities', label: '–ó–∞–Ω—è—Ç—Ç—è', subcategories: [
            {id: 'social', label: '–°–æ—Ü—ñ–∞–ª—å–Ω—ñ'},
            {id: 'personal', label: '–û—Å–æ–±–∏—Å—Ç—ñ'}
          ]},
          {id: 'behaviors', label: '–ü–æ–≤–µ–¥—ñ–Ω–∫–∞', subcategories: [
            {id: 'communication', label: '–°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è'},
            {id: 'habits', label: '–ó–≤–∏—á–∫–∏'}
          ]}
        ]
      },
      {id: 'anti_triggers', label: '–¢—Ä–∏–≥–µ—Ä–∏ —Ç–∞ —Ä–æ–∑–¥—Ä–∞—Ç—É–≤–∞–Ω–Ω—è', type: 'tags', category: 'antipreferences', importance: 'high'},
      {id: 'anti_topics', label: '–ù–µ–ø—Ä–∏—î–º–Ω—ñ —Ç–µ–º–∏ –¥–ª—è —Ä–æ–∑–º–æ–≤', type: 'tags', category: 'antipreferences', importance: 'medium'},
      {id: 'anti_places', label: '–ú—ñ—Å—Ü—è, —è–∫—ñ –Ω–µ –ø–æ–¥–æ–±–∞—é—Ç—å—Å—è', type: 'tags', category: 'antipreferences', importance: 'medium'},
      {id: 'anti_sounds', label: '–ù–µ–ø—Ä–∏—î–º–Ω—ñ –∑–≤—É–∫–∏/–∑–∞–ø–∞—Ö–∏', type: 'tags', category: 'antipreferences', importance: 'low'},
      {id: 'anti_situations', label: '–ù–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω—ñ —Å–∏—Ç—É–∞—Ü—ñ—ó', type: 'textarea', category: 'antipreferences', importance: 'medium'},
      {id: 'gift_wishlist', label: '–°–ø–∏—Å–æ–∫ –±–∞–∂–∞–Ω—å', type: 'tags', category: 'gifts', importance: 'high'},
      {id: 'gift_sizes', label: '–†–æ–∑–º—ñ—Ä–∏', type: 'text', category: 'gifts', importance: 'medium'},
      {id: 'gift_brands', label: '–£–ª—é–±–ª–µ–Ω—ñ –±—Ä–µ–Ω–¥–∏', type: 'tags', category: 'gifts', importance: 'medium'},
      {id: 'gift_anti', label: '–ê–Ω—Ç–∏–ø–æ–¥–∞—Ä—É–Ω–∫–∏', type: 'tags', category: 'gifts', importance: 'medium'},
      {id: 'gift_history', label: '–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤', type: 'textarea', category: 'gifts', importance: 'low'},
      {id: 'love_language', label: '–ú–æ–≤–∞ –∫–æ—Ö–∞–Ω–Ω—è', type: 'text', category: 'psychology', importance: 'high'},
      {id: 'values', label: '–û—Å–Ω–æ–≤–Ω—ñ —Ü—ñ–Ω–Ω–æ—Å—Ç—ñ', type: 'tags', category: 'psychology', importance: 'high'},
      {id: 'psy_conflict_style', label: '–°—Ç–∏–ª—å –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ –≤ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞—Ö', type: 'textarea', category: 'psych', importance: 'high'},
      {id: 'psy_compliments', label: '–Ø–∫ –ª—é–±–∏—Ç—å –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç–∏', type: 'textarea', category: 'psych', importance: 'medium'},
      {id: 'psy_stress_relief', label: '–°–ø–æ—Å–æ–±–∏ –∑–Ω—è—Ç—Ç—è —Å—Ç—Ä–µ—Å—É', type: 'tags', category: 'psych', importance: 'high'},
      {id: 'log_places', label: '–£–ª—é–±–ª–µ–Ω—ñ –º—ñ—Å—Ü—è', type: 'tags', category: 'logistics', importance: 'medium'},
      {id: 'log_social_circle', label: '–°–æ—Ü—ñ–∞–ª—å–Ω–µ –∫–æ–ª–æ', type: 'textarea', category: 'logistics', importance: 'medium'},
      {id: 'log_schedule_peak', label: '–ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ', type: 'text', category: 'logistics', importance: 'low'},
      {id: 'log_media', label: '–ú–µ–¥—ñ–∞ –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è', type: 'tags', category: 'logistics', importance: 'low'},
      {id: 'short_goals', label: '–ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ —Ü—ñ–ª—ñ', type: 'tags', category: 'goals', importance: 'high'},
      {id: 'goal_travel', label: '–ú—Ä—ñ—ó –ø—Ä–æ –ø–æ–¥–æ—Ä–æ–∂—ñ', type: 'tags', category: 'goals', importance: 'medium'},
      {id: 'goal_traditions', label: '–¢—Ä–∞–¥–∏—Ü—ñ—ó, —è–∫—ñ —Ö–æ—á–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏', type: 'textarea', category: 'goals', importance: 'medium'},
      {id: 'goal_cozy_ideal', label: '–Ü–¥–µ–∞–ª—å–Ω–∏–π –∑–∞—Ç–∏—à–Ω–∏–π –≤–µ—á—ñ—Ä', type: 'textarea', category: 'goals', importance: 'low'},

      // ===== Base: –∫–æ–Ω—Ç–∞–∫—Ç–∏ —Ç–∞ –±–∞–∑–æ–≤—ñ –¥–µ—Ç–∞–ª—ñ =====
      {id: 'contact_phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', category: 'base', importance: 'high'},
      {id: 'contact_email', label: 'Email', type: 'text', category: 'base', importance: 'medium'},
      {id: 'city', label: '–ú—ñ—Å—Ç–æ / –õ–æ–∫–∞—Ü—ñ—è', type: 'text', category: 'base', importance: 'medium'},
      {id: 'anniversary', label: '–†—ñ—á–Ω–∏—Ü—è / –í–∞–∂–ª–∏–≤–∞ –¥–∞—Ç–∞', type: 'date', category: 'base', importance: 'medium'},

      // ===== Character: –≥–ª–∏–±—à—ñ —Ä–∏—Å–∏ =====
      {id: 'attachment_style', label: '–°—Ç–∏–ª—å –ø—Ä–∏—Ö–∏–ª—å–Ω–æ—Å—Ç—ñ', type: 'text', category: 'character', importance: 'medium'},
      {id: 'humor_style', label: '–ü–æ—á—É—Ç—Ç—è –≥—É–º–æ—Ä—É', type: 'tags', category: 'character', importance: 'low'},
      {id: 'personal_boundaries', label: '–û—Å–æ–±–∏—Å—Ç—ñ –∫–æ—Ä–¥–æ–Ω–∏', type: 'textarea', category: 'character', importance: 'high'},

      // ===== Preferences: —Ä–æ–∑—à–∏—Ä–µ–Ω—ñ =====
      {id: 'cuisines_fav', label: '–£–ª—é–±–ª–µ–Ω—ñ –∫—É—Ö–Ω—ñ', type: 'tags', category: 'preferences', importance: 'medium'},
      {id: 'allergies', label: '–ê–ª–µ—Ä–≥—ñ—ó / –ß—É—Ç–ª–∏–≤–æ—Å—Ç—ñ', type: 'tags', category: 'preferences', importance: 'high'},
      {id: 'aesthetics', label: '–ï—Å—Ç–µ—Ç–∏–∫–∏ / –°—Ç–∏–ª—ñ', type: 'tags', category: 'preferences', importance: 'medium'},
      {id: 'fav_colors', label: '–£–ª—é–±–ª–µ–Ω—ñ –∫–æ–ª—å–æ—Ä–∏', type: 'tags', category: 'preferences', importance: 'low'},

      // ===== Anti-preferences: —Ä–æ–∑—à–∏—Ä–µ–Ω—ñ =====
      {id: 'anti_allergies', label: '–ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —á–µ—Ä–µ–∑ –∞–ª–µ—Ä–≥—ñ—ó', type: 'tags', category: 'antipreferences', importance: 'high'},
      {id: 'anti_people_types', label: '–¢–∏–ø–∏ –ª—é–¥–µ–π, –∑ —è–∫–∏–º–∏ –≤–∞–∂–∫–æ', type: 'tags', category: 'antipreferences', importance: 'medium'},

      // ===== Gifts: –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–¥–µ—ó =====
      {id: 'gift_price_range', label: '–ö–æ–º—Ñ–æ—Ä—Ç–Ω–∏–π –±—é–¥–∂–µ—Ç –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤', type: 'text', category: 'gifts', importance: 'low'},
      {id: 'gift_stores', label: '–£–ª—é–±–ª–µ–Ω—ñ –º–∞–≥–∞–∑–∏–Ω–∏ / –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏', type: 'tags', category: 'gifts', importance: 'low'},

      // ===== Psych: –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ =====
      {id: 'psy_anxiety_triggers', label: '–¢—Ä–∏–≥–µ—Ä–∏ —Ç—Ä–∏–≤–æ–≥–∏', type: 'tags', category: 'psych', importance: 'high'},
      {id: 'psy_motivators', label: '–©–æ –º–æ—Ç–∏–≤—É—î', type: 'tags', category: 'psych', importance: 'medium'},
      {id: 'psy_calming_words', label: '–°–ª–æ–≤–∞/—Ñ—Ä–∞–∑–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏', type: 'tags', category: 'psych', importance: 'medium'},

      // ===== Logistics: —Ä—É—Ç–∏–Ω–∏ —Ç–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è =====
      {id: 'log_transport', label: '–ó–≤–∏—á–Ω–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', type: 'tags', category: 'logistics', importance: 'low'},
      {id: 'log_work_hours', label: '–ì–æ–¥–∏–Ω–∏ —Ä–æ–±–æ—Ç–∏/–Ω–∞–≤—á–∞–Ω–Ω—è', type: 'text', category: 'logistics', importance: 'medium'},
      {id: 'log_routines', label: '–©–æ–¥–µ–Ω–Ω—ñ —Ä—É—Ç–∏–Ω–∏', type: 'textarea', category: 'logistics', importance: 'medium'},
      {id: 'log_food_schedule', label: '–•–∞—Ä—á–æ–≤–∏–π —Ä–µ–∂–∏–º', type: 'text', category: 'logistics', importance: 'low'},

      // ===== Goals: –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ —Ç–∞ —Ü—ñ–∫–∞–≤—ñ –Ω–∞–ø—Ä—è–º–∫–∏ =====
      {id: 'long_goals', label: '–î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ —Ü—ñ–ª—ñ', type: 'tags', category: 'goals', importance: 'high'},
      {id: 'learning_topics', label: '–©–æ —Ö–æ—á–µ –≤–∏–≤—á–∏—Ç–∏', type: 'tags', category: 'goals', importance: 'medium'},
      {id: 'bucket_list', label: 'Bucket list', type: 'tags', category: 'goals', importance: 'medium'},

      // ===== Custom: –≤—ñ–ª—å–Ω—ñ –Ω–æ—Ç–∞—Ç–∫–∏ =====
      {id: 'notes_private', label: '–û—Å–æ–±–∏—Å—Ç—ñ –Ω–æ—Ç–∞—Ç–∫–∏', type: 'textarea', category: 'custom', importance: 'low'},

      // ===== Communication: —Å—Ç–∏–ª—å —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è =====
      {id: 'comm_style', label: '–°—Ç–∏–ª—å —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è', type: 'tags', category: 'communication', importance: 'high'},
      {id: 'comm_frequency', label: '–ß–∞—Å—Ç–æ—Ç–∞ –±–∞–∂–∞–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É', type: 'text', category: 'communication', importance: 'medium'},
      {id: 'comm_topics_good', label: '–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ñ —Ç–µ–º–∏', type: 'tags', category: 'communication', importance: 'medium'},
      {id: 'comm_topics_bad', label: '–°–∫–ª–∞–¥–Ω—ñ —Ç–µ–º–∏', type: 'tags', category: 'communication', importance: 'high'},
      {id: 'comm_love_language', label: '–ú–æ–≤–∞ –ª—é–±–æ–≤—ñ –≤ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó', type: 'text', category: 'communication', importance: 'high'},

      // ===== Finance: —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –∑–≤–∏—á–∫–∏ =====
      {id: 'finance_habits', label: '–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –∑–≤–∏—á–∫–∏', type: 'textarea', category: 'finance', importance: 'medium'},
      {id: 'finance_attitude', label: '–°—Ç–∞–≤–ª–µ–Ω–Ω—è –¥–æ –≥—Ä–æ—à–µ–π', type: 'textarea', category: 'finance', importance: 'medium'},
      {id: 'finance_goals', label: '–°–ø—ñ–ª—å–Ω—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Ü—ñ–ª—ñ', type: 'tags', category: 'finance', importance: 'high'},
      {id: 'finance_split', label: '–†–æ–∑–ø–æ–¥—ñ–ª –≤–∏—Ç—Ä–∞—Ç', type: 'text', category: 'finance', importance: 'medium'},

      // ===== Intimacy: —ñ–Ω—Ç–∏–º–Ω—ñ—Å—Ç—å (–ü–†–ò–í–ê–¢–ù–ê) =====
      {id: 'intimacy_language', label: '–ú–æ–≤–∞ —ñ–Ω—Ç–∏–º–Ω–æ—Å—Ç—ñ', type: 'textarea', category: 'intimacy', importance: 'high'},
      {id: 'intimacy_boundaries', label: 'Boundaries —Ç–∞ –∫–æ–º—Ñ–æ—Ä—Ç', type: 'textarea', category: 'intimacy', importance: 'high'},
      {id: 'intimacy_gestures', label: '–†–æ–º–∞–Ω—Ç–∏—á–Ω—ñ –∂–µ—Å—Ç–∏', type: 'tags', category: 'intimacy', importance: 'medium'},

      // ===== Family: —Å—ñ–º'—è —Ç–∞ —Ä–æ–¥–∏–Ω–Ω—ñ –∑–≤'—è–∑–∫–∏ =====
      {id: 'family_info', label: '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ä–æ–¥–∏–Ω—É', type: 'textarea', category: 'family', importance: 'medium'},
      {id: 'family_important', label: '–í–∞–∂–ª–∏–≤—ñ –ª—é–¥–∏', type: 'tags', category: 'family', importance: 'high'},
      {id: 'family_traditions', label: '–°—ñ–º–µ–π–Ω—ñ —Ç—Ä–∞–¥–∏—Ü—ñ—ó', type: 'tags', category: 'family', importance: 'medium'},
      {id: 'family_attitude', label: '–°—Ç–∞–≤–ª–µ–Ω–Ω—è –¥–æ —Ä–æ–¥–∏–Ω–∏', type: 'textarea', category: 'family', importance: 'medium'},

      // ===== Career: –∫–∞—Ä'—î—Ä–∞ —Ç–∞ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ —Ü—ñ–ª—ñ =====
      {id: 'career_goals', label: '–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ —Ü—ñ–ª—ñ', type: 'tags', category: 'career', importance: 'medium'},
      {id: 'career_schedule', label: '–†–æ–±–æ—á–∏–π –≥—Ä–∞—Ñ—ñ–∫', type: 'text', category: 'career', importance: 'low'},
      {id: 'career_dreams', label: '–ö–∞—Ä\'—î—Ä–Ω—ñ –º—Ä—ñ—ó', type: 'textarea', category: 'career', importance: 'medium'},
      {id: 'career_balance', label: 'Work-life balance', type: 'textarea', category: 'career', importance: 'medium'},

      // ===== Culture: –∫—É–ª—å—Ç—É—Ä–∞ —Ç–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∏ =====
      {id: 'culture_religion', label: '–†–µ–ª—ñ–≥—ñ–π–Ω—ñ –ø–æ–≥–ª—è–¥–∏', type: 'text', category: 'culture', importance: 'medium'},
      {id: 'culture_politics', label: '–ü–æ–ª—ñ—Ç–∏—á–Ω—ñ –ø–µ—Ä–µ–∫–æ–Ω–∞–Ω–Ω—è', type: 'text', category: 'culture', importance: 'low'},
      {id: 'culture_traditions', label: '–ö—É–ª—å—Ç—É—Ä–Ω—ñ —Ç—Ä–∞–¥–∏—Ü—ñ—ó', type: 'tags', category: 'culture', importance: 'medium'},
      {id: 'culture_principles', label: '–ñ–∏—Ç—Ç—î–≤—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏', type: 'textarea', category: 'culture', importance: 'high'}
    ],
    values: {
      fullName: '–Ü–≤–∞–Ω–Ω–∞ –ü–µ—Ç—Ä–µ–Ω–∫–æ',
      dob: '1994-07-08',
      character: '–¢–∏—Ö–∞, —É–≤–∞–∂–Ω–∞, –≤—Ä–∞–∑–ª–∏–≤–∞, –∞–ª–µ —Ä—ñ—à—É—á–∞.',
      likes: {
        food: {
          sweet: ['—à–æ–∫–æ–ª–∞–¥', '—Ç—ñ—Ä–∞–º—ñ—Å—É'],
          drinks: ['–º–∞—Ç—á–∞']
        },
        activities: {
          active: ['–≤–µ–ª–æ—Å–ø–æ—Ä—Ç'],
          calm: ['—á–∏—Ç–∞–Ω–Ω—è']
        }
      }
    }
  };

  // ============= GOOGLE SHEETS SYNC =============
  const GoogleSheetsSync = {
    // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è API
    config: {
      apiKey: null,
      clientId: null,
      spreadsheetId: null,
      scopes: 'https://www.googleapis.com/auth/spreadsheets',
      discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
    },
    
    // OAuth —Ç–æ–∫–µ–Ω –∫–ª—ñ—î–Ω—Ç
    tokenClient: null,
    accessToken: null,
    gapiInitialized: false,
    gisInitialized: false,
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è GAPI
    async initGapi() {
      return new Promise((resolve, reject) => {
        if (this.gapiInitialized) {
          resolve();
          return;
        }
        
        if (typeof gapi === 'undefined') {
          reject(new Error('Google API –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ'));
          return;
        }
        
        gapi.load('client', async () => {
          try {
            await gapi.client.init({
              discoveryDocs: this.config.discoveryDocs,
            });
            this.gapiInitialized = true;
            resolve();
          } catch (error) {
            reject(error);
          }
        });
      });
    },
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è GIS (Google Identity Services)
    initGis(clientId) {
      return new Promise((resolve, reject) => {
        if (this.gisInitialized && this.config.clientId === clientId) {
          resolve();
          return;
        }
        
        if (typeof google === 'undefined') {
          reject(new Error('Google Identity Services –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ'));
          return;
        }
        
        this.config.clientId = clientId;
        
        this.tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: this.config.scopes,
          callback: '', // –ë—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ
        });
        
        this.gisInitialized = true;
        resolve();
      });
    },
    
    // OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
    async authorize() {
      return new Promise((resolve, reject) => {
        if (!this.tokenClient) {
          reject(new Error('Token client –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ'));
          return;
        }
        
        this.tokenClient.callback = async (response) => {
          if (response.error !== undefined) {
            reject(response);
            return;
          }
          
          this.accessToken = response.access_token;
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ sessionStorage (–ù–ï –≤ localStorage –¥–ª—è –±–µ–∑–ø–µ–∫–∏)
          sessionStorage.setItem('gapi_token', response.access_token);
          resolve(response);
        };
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î —Ç–æ–∫–µ–Ω –≤ sessionStorage
        const savedToken = sessionStorage.getItem('gapi_token');
        if (savedToken) {
          this.accessToken = savedToken;
          gapi.client.setToken({ access_token: savedToken });
          resolve({ access_token: savedToken });
        } else {
          // –ó–∞–ø–∏—Ç—É—î–º–æ –Ω–æ–≤–∏–π —Ç–æ–∫–µ–Ω
          this.tokenClient.requestAccessToken({ prompt: 'consent' });
        }
      });
    },
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    isAuthorized() {
      return this.accessToken !== null && gapi.client.getToken() !== null;
    },
    
    // –í—ñ–¥–∫–ª–∏–∫–∞—Ç–∏ –¥–æ—Å—Ç—É–ø
    revokeAccess() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken(null);
      }
      this.accessToken = null;
      sessionStorage.removeItem('gapi_token');
    },
    
    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó —Ç–∞–±–ª–∏—Ü—ñ (–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–û - 1 –ª–∏—Å—Ç!)
    async createSpreadsheet() {
      if (!this.isAuthorized()) {
        throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
      }
      
      const date = new Date().toISOString().split('T')[0];
      const title = `Dosier - ${date}`;
      
      try {
        const response = await gapi.client.sheets.spreadsheets.create({
          properties: {
            title: title
          },
          sheets: [
            { 
              properties: { 
                title: 'Data', 
                gridProperties: { frozenRowCount: 1 } 
              } 
            }
          ]
        });
        
        const spreadsheetId = response.result.spreadsheetId;
        this.config.spreadsheetId = spreadsheetId;
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        await this.initializeStructure(spreadsheetId);
        
        return {
          spreadsheetId: spreadsheetId,
          url: `https://docs.google.com/spreadsheets/d/${spreadsheetId}`
        };
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ:', error);
        throw error;
      }
    },
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞–±–ª–∏—Ü—ñ (–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–û - 1 –ª–∏—Å—Ç!)
    async initializeStructure(spreadsheetId) {
      try {
        // –°—Ç–≤–æ—Ä—é—î–º–æ headers –¥–ª—è Data –ª–∏—Å—Ç–∞
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: spreadsheetId,
          range: 'Data!A1:B1',
          valueInputOption: 'RAW',
          resource: {
            values: [['key', 'value']]
          }
        });
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏:', error);
        throw error;
      }
    },
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —É Google Sheets (–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–û - 1 –∑–∞–ø–∏—Ç!)
    async uploadData(config, values, encryptionPassword = null) {
      if (!this.isAuthorized()) {
        throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
      }
      
      const spreadsheetId = this.config.spreadsheetId;
      if (!spreadsheetId) {
        throw new Error('Spreadsheet ID –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      }
      
      try {
        const timestamp = new Date().toISOString();
        
        // –ì–æ—Ç—É—î–º–æ –≤–µ—Å—å payload –≤ –æ–¥–∏–Ω –æ–±'—î–∫—Ç
        const payload = {
          config: config,
          values: values,
          version: '2.0',
          lastSync: timestamp
        };
        
        let dataStr = JSON.stringify(payload);
        let encrypted = false;
        let salt = '';
        let iv = '';
        
        // –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        if (encryptionPassword) {
          const encryptedData = await this.encryption.encrypt(dataStr, encryptionPassword);
          dataStr = encryptedData.encrypted;
          encrypted = true;
          salt = encryptedData.salt;
          iv = encryptedData.iv;
        }
        
        // –í–°–Ü –¥–∞–Ω—ñ –≤ –û–î–ù–û–ú–£ –∑–∞–ø–∏—Ç—ñ!
        await gapi.client.sheets.spreadsheets.values.batchUpdate({
          spreadsheetId: spreadsheetId,
          resource: {
            valueInputOption: 'RAW',
            data: [
              {
                range: 'Data!A1:B5',
                values: [
                  ['key', 'value'],
                  ['data', dataStr],
                  ['encrypted', encrypted.toString()],
                  ['salt', salt],
                  ['iv', iv]
                ]
              }
            ]
          }
        });
        
        return { success: true, timestamp };
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
        throw error;
      }
    },
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ Google Sheets (–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–û - 1 –∑–∞–ø–∏—Ç!)
    async downloadData(encryptionPassword = null) {
      if (!this.isAuthorized()) {
        throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
      }
      
      const spreadsheetId = this.config.spreadsheetId;
      if (!spreadsheetId) {
        throw new Error('Spreadsheet ID –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      }
      
      try {
        // –ß–∏—Ç–∞—î–º–æ –í–°–Ü –¥–∞–Ω—ñ –û–î–ù–ò–ú –∑–∞–ø–∏—Ç–æ–º!
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: spreadsheetId,
          range: 'Data!A1:B5'
        });
        
        const rows = response.result.values || [];
        
        // –ü–∞—Ä—Å–∏–º–æ –¥–∞–Ω—ñ (–ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ header)
        let dataStr = '';
        let encrypted = false;
        let salt = '';
        let iv = '';
        
        for (let i = 1; i < rows.length; i++) {
          const [key, value] = rows[i];
          if (key === 'data') dataStr = value || '';
          if (key === 'encrypted') encrypted = value === 'true';
          if (key === 'salt') salt = value || '';
          if (key === 'iv') iv = value || '';
        }
        
        if (!dataStr) {
          throw new Error('–î–∞–Ω—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }
        
        // –î–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        if (encrypted && encryptionPassword) {
          dataStr = await this.encryption.decrypt(dataStr, encryptionPassword, salt, iv);
        } else if (encrypted && !encryptionPassword) {
          throw new Error('–î–∞–Ω—ñ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ. –í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è.');
        }
        
        // –ü–∞—Ä—Å–∏–º–æ JSON
        const payload = JSON.parse(dataStr);
        
        return {
          config: payload.config,
          values: payload.values,
          metadata: {
            version: payload.version,
            lastSync: payload.lastSync,
            encrypted: encrypted.toString()
          }
        };
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
        throw error;
      }
    },
    
    // –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è (AES-GCM)
    encryption: {
      // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–ª—é—á–∞ –∑ –ø–∞—Ä–æ–ª—è
      async deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);
        const saltBuffer = typeof salt === 'string' ? 
          this.hexToBuffer(salt) : salt;
        
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          passwordBuffer,
          'PBKDF2',
          false,
          ['deriveBits', 'deriveKey']
        );
        
        return await crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: saltBuffer,
            iterations: 100000,
            hash: 'SHA-256'
          },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['encrypt', 'decrypt']
        );
      },
      
      // –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è
      async encrypt(data, password) {
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(data);
        
        // –ì–µ–Ω–µ—Ä—É—î–º–æ salt —Ç–∞ IV
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –∫–ª—é—á
        const key = await this.deriveKey(password, salt);
        
        // –®–∏—Ñ—Ä—É—î–º–æ
        const encrypted = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv: iv },
          key,
          dataBuffer
        );
        
        return {
          encrypted: this.bufferToHex(new Uint8Array(encrypted)),
          iv: this.bufferToHex(iv),
          salt: this.bufferToHex(salt)
        };
      },
      
      // –î–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è
      async decrypt(encryptedHex, password, saltHex, ivHex) {
        const encryptedBuffer = this.hexToBuffer(encryptedHex);
        const iv = this.hexToBuffer(ivHex);
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –∫–ª—é—á
        const key = await this.deriveKey(password, saltHex);
        
        // –î–µ—à–∏—Ñ—Ä—É—î–º–æ
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: iv },
          key,
          encryptedBuffer
        );
        
        const decoder = new TextDecoder();
        return decoder.decode(decrypted);
      },
      
      // –•–µ—à –ø–∞—Ä–æ–ª—è –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
      async hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return this.bufferToHex(new Uint8Array(hash));
      },
      
      // Utilities
      bufferToHex(buffer) {
        return Array.from(buffer)
          .map(b => b.toString(16).padStart(2, '0'))
          .join('');
      },
      
      hexToBuffer(hex) {
        const bytes = new Uint8Array(hex.length / 2);
        for (let i = 0; i < hex.length; i += 2) {
          bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
        }
        return bytes;
      }
    }
  };

  // ============= STORAGE =============
  const Storage = {
    key: 'love_dossier_v2',
    syncKey: 'love_dossier_sync_settings',
    
    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–≤—Ä–∞—Ö–æ–≤—É—î —Ä–µ–∂–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó) + –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–Ø
    async save() {
      const mode = State.sync.mode;
      
      // –ó–∞–≤–∂–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ localStorage —è–∫ backup
      localStorage.setItem(this.key, JSON.stringify({
        config: State.config,
        values: State.values,
        savedAt: new Date().toISOString()
      }));
      
      // –Ø–∫—â–æ Google Sheets —Ä–µ–∂–∏–º - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ
      if (mode === 'googleSheets' && State.sync.googleSheets.enabled) {
        try {
          SyncManager.updateStatus('syncing', '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...');
          
          const password = State.sync.googleSheets.encryptionEnabled ? 
            sessionStorage.getItem('encryption_password') : null;
          
          await GoogleSheetsSync.uploadData(State.config, State.values, password);
          
          State.sync.googleSheets.lastSync = new Date().toISOString();
          this.saveSyncSettings();
          
          // –°–∫–∏–¥–∞—î–º–æ —Ñ–ª–∞–≥ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∑–º—ñ–Ω
          SyncManager.hasUnsyncedChanges = false;
          
          SyncManager.updateStatus('synced', `–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ ${this.formatTime(new Date())}`);
          Toast.show('‚òÅÔ∏è –î–∞–Ω—ñ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ –∑ Google Sheets');
        } catch (error) {
          console.error('Sync error:', error);
          State.sync.lastError = error.message;
          SyncManager.updateStatus('error', '–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó');
          Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó: ' + error.message, 'error');
          
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω–æ —è–∫—â–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—å
          Toast.show('üíæ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
        }
      } else {
        SyncManager.updateStatus('local', 'Local —Ä–µ–∂–∏–º');
      }
    },
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (–≤—Ä–∞—Ö–æ–≤—É—î —Ä–µ–∂–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó)
    async load() {
      const mode = State.sync.mode;
      
      // –Ø–∫—â–æ Google Sheets —Ä–µ–∂–∏–º
      if (mode === 'googleSheets' && State.sync.googleSheets.enabled) {
        try {
          if (!GoogleSheetsSync.isAuthorized()) {
            throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ –≤ Google');
          }
          
          const password = State.sync.googleSheets.encryptionEnabled ? 
            sessionStorage.getItem('encryption_password') : null;
          
          const result = await GoogleSheetsSync.downloadData(password);
          Toast.show('‚òÅÔ∏è –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ Google Sheets');
          return result;
        } catch (error) {
          console.error('Load from Google Sheets error:', error);
          Toast.show('‚ö†Ô∏è –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ backup', 'warning');
          // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ localStorage
          return this.loadFromLocalStorage();
        }
      }
      
      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ localStorage
      return this.loadFromLocalStorage();
    },
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ localStorage
    loadFromLocalStorage() {
      try {
        const data = localStorage.getItem(this.key);
        if (!data) return null;
        return JSON.parse(data);
      } catch (e) {
        console.error('Error loading data:', e);
        return null;
      }
    },
    
    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    saveSyncSettings() {
      localStorage.setItem(this.syncKey, JSON.stringify({
        mode: State.sync.mode,
        googleSheets: {
          enabled: State.sync.googleSheets.enabled,
          clientId: State.sync.googleSheets.clientId,
          spreadsheetId: State.sync.googleSheets.spreadsheetId,
          lastSync: State.sync.googleSheets.lastSync,
          autoSyncEnabled: State.sync.googleSheets.autoSyncEnabled,
          autoSyncInterval: State.sync.googleSheets.autoSyncInterval,
          encryptionEnabled: State.sync.googleSheets.encryptionEnabled,
          encryptionPasswordHash: State.sync.googleSheets.encryptionPasswordHash
        }
      }));
    },
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    loadSyncSettings() {
      try {
        const data = localStorage.getItem(this.syncKey);
        if (!data) return null;
        return JSON.parse(data);
      } catch (e) {
        console.error('Error loading sync settings:', e);
        return null;
      }
    },
    
    // –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ
    clear() {
      localStorage.removeItem(this.key);
    },
    
    // –ï–∫—Å–ø–æ—Ä—Ç –≤ JSON —Ñ–∞–π–ª
    exportToFile() {
      const data = {
        config: State.config,
        values: State.values,
        exportedAt: new Date().toISOString(),
        version: '2.0'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dossier-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    },
    
    // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É
    formatTime(date) {
      return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
    }
  };

  // ============= SYNC MANAGER =============
  const SyncManager = {
    autoSyncInterval: null,
    hasUnsyncedChanges: false, // –§–ª–∞–≥ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∑–º—ñ–Ω
    lastSyncData: null, // –û—Å—Ç–∞–Ω–Ω—ñ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ
    
    // –ü–æ–∑–Ω–∞—á–∏—Ç–∏ —â–æ —î –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏
    markDirty() {
      this.hasUnsyncedChanges = true;
    },
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –≤ UI
    updateStatus(status, text) {
      State.sync.status = status;
      State.sync.statusText = text;
      
      const statusEl = document.getElementById('syncStatus');
      if (!statusEl) return;
      
      // –û—á–∏—â—É—î–º–æ –≤—Å—ñ –∫–ª–∞—Å–∏
      statusEl.className = 'sync-status';
      statusEl.classList.add(status);
      
      // –Ü–∫–æ–Ω–∫–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å—Ç–∞—Ç—É—Å—ñ–≤
      const icons = {
        local: 'fa-laptop',
        synced: 'fa-check-circle',
        syncing: 'fa-sync-alt fa-spin',
        error: 'fa-exclamation-circle',
        offline: 'fa-wifi'
      };
      
      statusEl.innerHTML = `
        <i class="fas ${icons[status] || 'fa-laptop'}"></i>
        <span>${text}</span>
      `;
    },
    
    // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó (–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–û - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –∑–º—ñ–Ω–∏!)
    startAutoSync(intervalMinutes) {
      this.stopAutoSync();
      
      if (!State.sync.googleSheets.enabled || !State.sync.googleSheets.autoSyncEnabled) {
        return;
      }
      
      console.log(`üîÑ Auto-sync: –∫–æ–∂–Ω—ñ ${intervalMinutes} —Ö–≤ (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –∑–º—ñ–Ω–∏)`);
      
      this.autoSyncInterval = setInterval(async () => {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏
        if (!this.hasUnsyncedChanges) {
          console.log('‚è≠Ô∏è Auto-sync: –Ω–µ–º–∞—î –∑–º—ñ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ');
          return;
        }
        
        if (navigator.onLine && GoogleSheetsSync.isAuthorized()) {
          try {
            console.log('üîÑ Auto-sync: —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...');
            await Storage.save();
            this.hasUnsyncedChanges = false;
          } catch (error) {
            console.error('Auto-sync failed:', error);
          }
        } else {
          console.log('‚ö†Ô∏è Auto-sync: offline –∞–±–æ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
        }
      }, intervalMinutes * 60 * 1000);
    },
    
    // –ó—É–ø–∏–Ω–∫–∞ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    stopAutoSync() {
      if (this.autoSyncInterval) {
        clearInterval(this.autoSyncInterval);
        this.autoSyncInterval = null;
        console.log('Auto-sync stopped');
      }
    },
    
    // –†—É—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
    async manualSync() {
      if (!GoogleSheetsSync.isAuthorized()) {
        Toast.show('‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ Google', 'error');
        return;
      }
      
      try {
        this.updateStatus('syncing', '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...');
        await Storage.save();
        Toast.show('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
      } catch (error) {
        console.error('Manual sync error:', error);
        Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó: ' + error.message, 'error');
      }
    },
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–≤—Ç–æ—Å–∏–Ω—Ö)
    async init() {
      // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
      const syncSettings = Storage.loadSyncSettings();
      if (syncSettings) {
        State.sync.mode = syncSettings.mode;
        Object.assign(State.sync.googleSheets, syncSettings.googleSheets);
        
        // –Ø–∫—â–æ Google Sheets —Ä–µ–∂–∏–º
        if (syncSettings.mode === 'googleSheets' && syncSettings.googleSheets.enabled) {
          try {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Google API
            await GoogleSheetsSync.initGapi();
            await GoogleSheetsSync.initGis(syncSettings.googleSheets.clientId);
            
            GoogleSheetsSync.config.spreadsheetId = syncSettings.googleSheets.spreadsheetId;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é –∑ sessionStorage
            const savedToken = sessionStorage.getItem('gapi_token');
            if (savedToken) {
              GoogleSheetsSync.accessToken = savedToken;
              if (typeof gapi !== 'undefined' && gapi.client) {
                gapi.client.setToken({ access_token: savedToken });
              }
            }
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é
            if (syncSettings.googleSheets.autoSyncEnabled) {
              this.startAutoSync(syncSettings.googleSheets.autoSyncInterval);
            }
            
            const lastSync = syncSettings.googleSheets.lastSync;
            if (lastSync) {
              const date = new Date(lastSync);
              this.updateStatus('synced', `–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ ${Storage.formatTime(date)}`);
            } else {
              this.updateStatus('synced', 'Google Sheets');
            }
          } catch (error) {
            console.error('Sync init error:', error);
            this.updateStatus('error', '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó');
          }
        } else {
          this.updateStatus('local', 'Local —Ä–µ–∂–∏–º');
        }
      } else {
        this.updateStatus('local', 'Local —Ä–µ–∂–∏–º');
      }
      
      // –û–±—Ä–æ–±–∫–∞ online/offline
      window.addEventListener('online', () => {
        if (State.sync.mode === 'googleSheets') {
          Toast.show('üåê –ó\'—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ', 'info');
          this.updateStatus('synced', 'Online');
          this.manualSync();
        }
      });
      
      window.addEventListener('offline', () => {
        if (State.sync.mode === 'googleSheets') {
          Toast.show('‚ö†Ô∏è –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', 'warning');
          this.updateStatus('offline', '–û—Ñ–ª–∞–π–Ω');
        }
      });
    }
  };

  // ============= FORMAT MENU =============
  const FormatMenu = {
    menu: document.getElementById('formatMenu'),
    activeInput: null,
    selectionStart: 0,
    selectionEnd: 0,
    
    init() {
      // –û–±—Ä–æ–±–∫–∞ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ input —Ç–∞ textarea
      const handleSelectionEvent = (e) => {
        const target = e.target;
        if (target.matches('.form-input, .form-textarea')) {
          this.handleSelection(target, e);
        } else {
          this.hide();
        }
      };
      
      document.addEventListener('mouseup', handleSelectionEvent);
      document.addEventListener('touchend', handleSelectionEvent);
      
      // –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—ñ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞—Ö —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
      this.menu.querySelectorAll('.format-menu-btn').forEach(btn => {
        const handleFormatClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const format = btn.dataset.format;
          this.applyFormat(format);
        };
        
        btn.addEventListener('mousedown', handleFormatClick);
        btn.addEventListener('touchstart', handleFormatClick);
      });
      
      // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –º–µ–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
      const handleClickOutside = (e) => {
        if (!this.menu.contains(e.target) && !e.target.matches('.form-input, .form-textarea')) {
          this.hide();
        }
      };
      
      document.addEventListener('mousedown', handleClickOutside);
      document.addEventListener('touchstart', handleClickOutside);
      
      // –ì–∞—Ä—è—á—ñ –∫–ª–∞–≤—ñ—à—ñ
      document.addEventListener('keydown', (e) => {
        if (!this.activeInput) return;
        
        if (e.ctrlKey || e.metaKey) {
          if (e.key === 'b') {
            e.preventDefault();
            this.applyFormat('bold');
          } else if (e.key === 'i') {
            e.preventDefault();
            this.applyFormat('italic');
          } else if (e.key === 'k') {
            e.preventDefault();
            this.applyFormat('link');
          }
        }
      });
    },
    
    handleSelection(input, event) {
      // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö, —â–æ–± –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –≤—Å—Ç–∏–≥–ª–æ –≤—ñ–¥–±—É—Ç–∏—Å—è
      setTimeout(() => {
        const selectedText = this.getSelectedText(input);
        
        if (selectedText && selectedText.length > 0) {
          this.activeInput = input;
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
          this.selectionStart = input.selectionStart;
          this.selectionEnd = input.selectionEnd;
          
          // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è touch –∞–±–æ mouse –ø–æ–¥—ñ—ó
          let x, y;
          if (event.type.startsWith('touch')) {
            const touch = event.changedTouches[0] || event.touches[0];
            x = touch.pageX;
            y = touch.pageY;
          } else {
            x = event.pageX;
            y = event.pageY;
          }
          
          this.show(x, y);
        } else {
          this.hide();
        }
      }, 50);
    },
    
    getSelectedText(input) {
      const start = input.selectionStart;
      const end = input.selectionEnd;
      return input.value.substring(start, end);
    },
    
    show(x, y) {
      this.menu.style.left = `${x}px`;
      this.menu.style.top = `${y - 50}px`;
      this.menu.classList.add('active');
    },
    
    hide() {
      this.menu.classList.remove('active');
      this.activeInput = null;
    },
    
    applyFormat(format) {
      if (!this.activeInput) return;
      
      const input = this.activeInput;
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó
      const start = this.selectionStart;
      const end = this.selectionEnd;
      const selectedText = input.value.substring(start, end);
      
      if (!selectedText) return;
      
      let formattedText = '';
      
      switch(format) {
        case 'bold':
          formattedText = `**${selectedText}**`;
          break;
        case 'italic':
          formattedText = `*${selectedText}*`;
          break;
        case 'strikethrough':
          formattedText = `~~${selectedText}~~`;
          break;
        case 'link':
          const url = prompt('–í–≤–µ–¥—ñ—Ç—å URL:', 'https://');
          if (url) {
            formattedText = `[${selectedText}](${url})`;
          } else {
            return;
          }
          break;
        case 'chip':
          formattedText = `<chip>${selectedText}</chip>`;
          break;
      }
      
      // –ó–∞–º—ñ–Ω—é—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–∏–π
      const newValue = input.value.substring(0, start) + formattedText + input.value.substring(end);
      input.value = newValue;
      
      // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫—É—Ä—Å–æ—Ä –ø—ñ—Å–ª—è –≤—Å—Ç–∞–≤–ª–µ–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
      const newCursorPos = start + formattedText.length;
      input.setSelectionRange(newCursorPos, newCursorPos);
      input.focus();
      
      this.hide();
    }
  };

  // ============= TOAST =============
  const Toast = {
    container: document.getElementById('toastContainer'),
    
    show(message, type = 'success') {
      // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∞ —Å—Ç–∏–ª—å –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ç–∏–ø—É
      const config = {
        success: { 
          duration: 3000, 
          icon: 'fa-check-circle', 
          class: 'toast-success' 
        },
        error: { 
          duration: 6000,  // ‚ùó –ü–æ–º–∏–ª–∫–∏ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –¥–æ–≤—à–µ!
          icon: 'fa-exclamation-circle', 
          class: 'toast-error' 
        },
        warning: { 
          duration: 5000,  // ‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —Ç–µ–∂ –¥–æ–≤—à–µ
          icon: 'fa-exclamation-triangle', 
          class: 'toast-warning' 
        },
        info: { 
          duration: 4000, 
          icon: 'fa-info-circle', 
          class: 'toast-info' 
        }
      };
      
      const settings = config[type] || config.success;
      
      const toast = document.createElement('div');
      toast.className = `toast ${settings.class}`;
      toast.innerHTML = `
        <i class="fas ${settings.icon}"></i>
        <span>${message}</span>
      `;
      
      this.container.appendChild(toast);
      
      // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏
      setTimeout(() => toast.classList.add('show'), 10);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è
      setTimeout(() => {
        toast.classList.remove('show');
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 300);
      }, settings.duration);
      
      // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É
      toast.addEventListener('click', () => {
        toast.classList.remove('show');
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 300);
      });
    }
  };

  // ============= MODAL =============
  const Modal = {
    backdrop: document.getElementById('modalBackdrop'),
    title: document.getElementById('modalTitle'),
    titleIcon: document.getElementById('modalTitleIcon'),
    body: document.getElementById('modalBody'),
    saveBtn: document.getElementById('modalSave'),
    cancelBtn: document.getElementById('modalCancel'),
    closeBtn: document.getElementById('modalClose'),
    
    open(title, contentHtml, options = {}) {
      const { onSave, icon = 'fa-edit', size = 'medium', onOpen } = options;
      
      this.title.textContent = title;
      this.titleIcon.className = `fas ${icon} modal-title-icon`;
      this.body.innerHTML = contentHtml;
      
      // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å —Ä–æ–∑–º—ñ—Ä—É –¥–æ –º–æ–¥–∞–ª–∫–∏
      const modal = this.backdrop.querySelector('.modal');
      modal.classList.remove('modal-large', 'modal-small');
      if (size === 'large') {
        modal.classList.add('modal-large');
      } else if (size === 'small') {
        modal.classList.add('modal-small');
      }
      
      // –í–∏–¥–∞–ª—è—î–º–æ closing —è–∫—â–æ –≤—ñ–Ω –∑–∞–ª–∏—à–∏–≤—Å—è
      this.backdrop.classList.remove('closing');
      
      // –ü–æ–∫–∞–∑—É—î–º–æ backdrop –±–µ–∑ –∞–Ω—ñ–º–∞—Ü—ñ—ó
      this.backdrop.style.display = 'flex';
      
      // –î–æ–¥–∞—î–º–æ active –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          this.backdrop.classList.add('active');
        });
      });
      
      this.saveBtn.onclick = async () => {
        if (onSave) {
          const result = await onSave();
          if (result !== false) {
            this.close();
          }
        } else {
          this.close();
        }
      };
      
      // –í–∏–∫–ª–∏–∫–∞—î–º–æ callback –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è (–¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó event listeners)
      if (onOpen) {
        setTimeout(() => onOpen(), 0);
      }
    },
    
    close() {
      // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –∑–∞–∫—Ä–∏—Ç—Ç—è
      this.backdrop.classList.add('closing');
      this.backdrop.classList.remove('active');
      
      // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥ –ø–æ–≤–Ω–∏–º –∑–∞–∫—Ä–∏—Ç—Ç—è–º
      setTimeout(() => {
        this.backdrop.classList.remove('closing');
        this.backdrop.style.display = 'none';
        State.ui.modalData = null;
      }, 200); // 200ms = —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å transition
    },
    
    init() {
      this.cancelBtn.onclick = () => this.close();
      this.closeBtn.onclick = () => this.close();
      this.backdrop.onclick = (e) => {
        if (e.target === this.backdrop) this.close();
      };
    }
  };

  // ============= CUSTOM SELECT =============
  const CustomSelect = {
    init(selectElement, options) {
      const container = document.createElement('div');
      container.className = 'custom-select';
      
      const selectedOption = options.find(opt => opt.selected) || options[0];
      
      // Trigger
      const trigger = document.createElement('div');
      trigger.className = 'custom-select-trigger';
      trigger.innerHTML = `
        ${selectedOption.icon ? `<i class="fas ${selectedOption.icon} custom-select-icon"></i>` : ''}
        <span class="custom-select-text">${selectedOption.label}</span>
      `;
      
      // Dropdown
      const dropdown = document.createElement('div');
      dropdown.className = 'custom-select-dropdown';
      
      options.forEach(opt => {
        const option = document.createElement('div');
        option.className = 'custom-select-option';
        if (opt.value === selectedOption.value) option.classList.add('selected');
        option.dataset.value = opt.value;
        option.innerHTML = `
          ${opt.icon ? `<i class="fas ${opt.icon} custom-select-option-icon"></i>` : ''}
          <span class="custom-select-option-text">${opt.label}</span>
        `;
        
        option.onclick = () => {
          // Update trigger
          trigger.innerHTML = `
            ${opt.icon ? `<i class="fas ${opt.icon} custom-select-icon"></i>` : ''}
            <span class="custom-select-text">${opt.label}</span>
          `;
          
          // Update selected
          dropdown.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          
          // Update original select
          selectElement.value = opt.value;
          selectElement.dispatchEvent(new Event('change'));
          
          // Close dropdown
          container.classList.remove('active');
          dropdown.classList.remove('active');
        };
        
        dropdown.appendChild(option);
      });
      
      // Position dropdown
      const positionDropdown = () => {
        const rect = trigger.getBoundingClientRect();
        const dropdownHeight = dropdown.offsetHeight || 300; // max-height
        const viewportHeight = window.innerHeight;
        const spaceBelow = viewportHeight - rect.bottom;
        const spaceAbove = rect.top;
        
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ —á–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ dropdown –∑–≤–µ—Ä—Ö—É —á–∏ –∑–Ω–∏–∑—É
        let top;
        if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
          // –ü–æ–∫–∞–∑—É—î–º–æ –∑–≤–µ—Ä—Ö—É
          top = rect.top - dropdownHeight - 8;
          dropdown.style.transformOrigin = 'bottom';
        } else {
          // –ü–æ–∫–∞–∑—É—î–º–æ –∑–Ω–∏–∑—É
          top = rect.bottom + 8;
          dropdown.style.transformOrigin = 'top';
        }
        
        // –û–±–º–µ–∂—É—î–º–æ –≤–∏—Å–æ—Ç—É —è–∫—â–æ –Ω–µ –≤–º—ñ—â–∞—î—Ç—å—Å—è
        const maxHeight = Math.min(300, Math.max(spaceBelow, spaceAbove) - 16);
        dropdown.style.maxHeight = `${maxHeight}px`;
        
        dropdown.style.top = `${Math.max(8, top)}px`;
        dropdown.style.left = `${rect.left}px`;
        dropdown.style.width = `${rect.width}px`;
      };
      
      // Toggle dropdown
      trigger.onclick = (e) => {
        e.stopPropagation();
        const wasActive = container.classList.contains('active');
        
        // Close other selects
        document.querySelectorAll('.custom-select.active').forEach(s => {
          s.classList.remove('active');
        });
        document.querySelectorAll('.custom-select-dropdown.active').forEach(d => {
          d.classList.remove('active');
        });
        
        if (!wasActive) {
          container.classList.add('active');
          dropdown.classList.add('active');
          positionDropdown();
        }
      };
      
      // Reposition on scroll/resize
      window.addEventListener('scroll', () => {
        if (container.classList.contains('active')) {
          positionDropdown();
        }
      }, true);
      
      window.addEventListener('resize', () => {
        if (container.classList.contains('active')) {
          positionDropdown();
        }
      });
      
      // Close on outside click
      document.addEventListener('click', () => {
        container.classList.remove('active');
        dropdown.classList.remove('active');
      });
      
      container.appendChild(trigger);
      document.body.appendChild(dropdown);
      
      // Replace original select
      selectElement.style.display = 'none';
      selectElement.parentNode.insertBefore(container, selectElement);
      
      // Cleanup on container removal
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.removedNodes.forEach((node) => {
            if (node === container || node.contains(container)) {
              dropdown.remove();
              observer.disconnect();
            }
          });
        });
      });
      observer.observe(document.body, { childList: true, subtree: true });
      
      return container;
    }
  };

  // ============= SEARCH =============
  const Search = {
    query: '',
    debounceTimeout: null,
    
    // Debounce helper
    debounce(func, wait) {
      return (...args) => {
        clearTimeout(this.debounceTimeout);
        this.debounceTimeout = setTimeout(() => func(...args), wait);
      };
    },
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—à—É–∫—É
    init() {
      const searchInput = document.getElementById('searchInput');
      const searchClearBtn = document.getElementById('searchClearBtn');
      
      if (!searchInput) return;
      
      // –û–±—Ä–æ–±–Ω–∏–∫ –≤–≤–µ–¥–µ–Ω–Ω—è –∑ debounce
      const handleSearch = this.debounce((query) => {
        this.query = query;
        this.performSearch();
      }, 300);
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ/—Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É –æ—á–∏—â–µ–Ω–Ω—è
        if (query) {
          searchClearBtn.classList.add('visible');
        } else {
          searchClearBtn.classList.remove('visible');
        }
        
        handleSearch(query);
      });
      
      // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è
      if (searchClearBtn) {
        searchClearBtn.addEventListener('click', () => {
          searchInput.value = '';
          searchClearBtn.classList.remove('visible');
          this.query = '';
          this.performSearch();
          searchInput.focus();
        });
      }
      
      // –û—á–∏—â–µ–Ω–Ω—è –ø–æ—à—É–∫—É –ø—Ä–∏ Escape
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchInput.value = '';
          searchClearBtn.classList.remove('visible');
          this.query = '';
          this.performSearch();
        }
      });
    },
    
    // –í–∏–∫–æ–Ω—É—î –ø–æ—à—É–∫
    performSearch() {
      // –Ø–∫—â–æ —î –∞–∫—Ç–∏–≤–Ω–∏–π –ø–æ—à—É–∫, –ø–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ –≤—Å—ñ—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö
      if (this.query) {
        State.ui.searchActive = true;
        State.ui.activeCategory = null; // –°–∫–∏–¥–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
      } else {
        State.ui.searchActive = false;
        State.ui.activeCategory = State.ui.lastActiveCategory || 'base';
      }
      
      Renderer.renderCategories();
      Renderer.renderContent();
      Progress.update();
    },
    
    // –§—ñ–ª—å—Ç—Ä—É—î –ø–æ–ª—è –∑–∞ –∑–∞–ø–∏—Ç–æ–º
    filterFields(fields) {
      if (!this.query) return fields;
      
      const lowerQuery = this.query.toLowerCase();
      
      return fields.filter(field => {
        // –ü–æ—à—É–∫ –≤ –Ω–∞–∑–≤—ñ –ø–æ–ª—è
        if (field.label.toLowerCase().includes(lowerQuery)) return true;
        
        // –ü–æ—à—É–∫ –≤ –∑–Ω–∞—á–µ–Ω–Ω—ñ
        const value = State.values[field.id];
        if (!value) return false;
        
        // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
        if (typeof value === 'string') {
          return value.toLowerCase().includes(lowerQuery);
        }
        
        // –î–ª—è —Ç–µ–≥—ñ–≤
        if (Array.isArray(value)) {
          return value.some(v => v.toLowerCase().includes(lowerQuery));
        }
        
        // –î–ª—è nested –ø–æ–ª—ñ–≤
        if (typeof value === 'object') {
          return JSON.stringify(value).toLowerCase().includes(lowerQuery);
        }
        
        return false;
      });
    },
    
    // Highlight –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –∑–±—ñ–≥—ñ–≤
    highlightText(text) {
      if (!this.query || !text) return text;
      
      const regex = new RegExp(`(${this.escapeRegex(this.query)})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    },
    
    // Escape regex —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ñ–≤
    escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
  };

  // ============= PROGRESS =============
  const Progress = {
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –ø–æ–ª–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ
    isFieldFilled(fieldId) {
      const field = State.config.fields.find(f => f.id === fieldId);
      if (!field) return false;
      
      const value = State.values[fieldId];
      
      // text/textarea: value !== '' && value !== null && value !== undefined
      if (field.type === 'text' || field.type === 'textarea') {
        return value !== '' && value !== null && value !== undefined;
      }
      
      // date: value !== '' && value !== null
      if (field.type === 'date') {
        return value !== '' && value !== null && value !== undefined;
      }
      
      // tags: array.length > 0
      if (field.type === 'tags') {
        return Array.isArray(value) && value.length > 0;
      }
      
      // nested: —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ø—ñ–¥–ø—É–Ω–∫—Ç –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π
      if (field.type === 'nested') {
        if (!value || typeof value !== 'object') return false;
        
        for (const catKey in value) {
          for (const subKey in value[catKey]) {
            const items = value[catKey][subKey];
            if (Array.isArray(items) && items.length > 0) {
              return true;
            }
          }
        }
        return false;
      }
      
      return false;
    },
    
    // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î –ø—Ä–æ–≥—Ä–µ—Å –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
    calculateProgress(categoryId) {
      if (!categoryId) {
        return { filled: 0, total: 0, percentage: 0 };
      }
      
      const fields = State.config.fields.filter(f => f.category === categoryId);
      const total = fields.length;
      
      if (total === 0) {
        return { filled: 0, total: 0, percentage: 0 };
      }
      
      const filled = fields.filter(f => this.isFieldFilled(f.id)).length;
      const percentage = Math.round((filled / total) * 100);
      
      return { filled, total, percentage };
    },
    
    // –û–Ω–æ–≤–ª—é—î UI –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä—É
    update() {
      const progressBarFill = document.getElementById('progressBarFill');
      const progressBarText = document.getElementById('progressBarText');
      
      if (!progressBarFill || !progressBarText) return;
      
      const categoryId = State.ui.activeCategory;
      
      if (!categoryId) {
        progressBarFill.style.width = '0%';
        progressBarText.textContent = '–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é';
        return;
      }
      
      const { filled, total, percentage } = this.calculateProgress(categoryId);
      const category = State.config.categories.find(c => c.id === categoryId);
      const categoryName = category ? category.label : '–ö–∞—Ç–µ–≥–æ—Ä—ñ—è';
      
      progressBarFill.style.width = `${percentage}%`;
      progressBarText.textContent = `${categoryName}: ${filled} –∑ ${total} –ø–æ–ª—ñ–≤ (${percentage}%)`;
      
      // –û–Ω–æ–≤–ª—é—î–º–æ tooltip
      const container = progressBarFill.parentElement;
      if (container) {
        container.title = `–ó–∞–ø–æ–≤–Ω–µ–Ω–æ ${filled} –∑ ${total} –ø–æ–ª—ñ–≤ —É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "${categoryName}"`;
      }
    }
  };

  // ============= RENDERER =============
  const Renderer = {
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é markdown-–ø–æ–¥—ñ–±–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É
    // –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
    // **–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç** –∞–±–æ __–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç__ ‚Üí <strong>–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç</strong>
    // *–∫—É—Ä—Å–∏–≤* –∞–±–æ _–∫—É—Ä—Å–∏–≤_ ‚Üí <em>–∫—É—Ä—Å–∏–≤</em>
    // ~~–∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π~~ ‚Üí <del>–∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π</del>
    // [—Ç–µ–∫—Å—Ç](url) ‚Üí <a href="url">—Ç–µ–∫—Å—Ç</a>
    formatText(text) {
      if (!text || typeof text !== 'string') return text;
      
      // –°–ø–æ—á–∞—Ç–∫—É –æ–±—Ä–æ–±–ª—è—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è [—Ç–µ–∫—Å—Ç](url) –î–û –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –º–∞—Ä–∫–µ—Ä —è–∫–∏–π –Ω–µ –±—É–¥–µ –µ–∫—Ä–∞–Ω–æ–≤–∞–Ω–∏–π
      const links = [];
      text = text.replace(/\[(.+?)\]\((.+?)\)/g, (match, linkText, url) => {
        const placeholder = `¬ß¬ß¬ßLINK${links.length}¬ß¬ß¬ß`;
        links.push({ text: linkText, url: url });
        return placeholder;
      });
      
      // –û–±—Ä–æ–±–ª—è—î–º–æ <chip>—Ç–µ–∫—Å—Ç</chip> –î–û –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è
      const chips = [];
      text = text.replace(/<chip>(.+?)<\/chip>/g, (match, chipText) => {
        const placeholder = `¬ß¬ß¬ßCHIP${chips.length}¬ß¬ß¬ß`;
        chips.push(chipText);
        return placeholder;
      });
      
      // –ï–∫—Ä–∞–Ω—É—î–º–æ HTML —Ç–µ–≥–∏ –¥–ª—è –±–µ–∑–ø–µ–∫–∏ (–∞–ª–µ –Ω–µ –Ω–∞—à—ñ –º–∞—Ä–∫–µ—Ä–∏ ¬ß¬ß¬ß)
      text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      // **–∂–∏—Ä–Ω–∏–π** –∞–±–æ __–∂–∏—Ä–Ω–∏–π__ (–∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏ –Ω–∞–≤–∫–æ–ª–æ)
      text = text.replace(/(\s?)\*\*(.+?)\*\*(\s?)/g, (match, before, content, after) => {
        return `${before}<strong>${content}</strong>${after}`;
      });
      text = text.replace(/(\s?)__(.+?)__(\s?)/g, (match, before, content, after) => {
        return `${before}<strong>${content}</strong>${after}`;
      });
      
      // *–∫—É—Ä—Å–∏–≤* –∞–±–æ _–∫—É—Ä—Å–∏–≤_ (–∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏ –Ω–∞–≤–∫–æ–ª–æ)
      text = text.replace(/(\s?)\*(.+?)\*(\s?)/g, (match, before, content, after) => {
        return `${before}<em>${content}</em>${after}`;
      });
      text = text.replace(/(\s?)_(.+?)_(\s?)/g, (match, before, content, after) => {
        return `${before}<em>${content}</em>${after}`;
      });
      
      // ~~–∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π~~ (–∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏ –Ω–∞–≤–∫–æ–ª–æ)
      text = text.replace(/(\s?)~~(.+?)~~(\s?)/g, (match, before, content, after) => {
        return `${before}<del>${content}</del>${after}`;
      });
      
      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º–Ω–æ–∂–∏–Ω–Ω—ñ –ø—Ä–æ–±—ñ–ª–∏ (–∑–∞–º—ñ–Ω—é—î–º–æ –ø–æ–¥–≤—ñ–π–Ω—ñ –ø—Ä–æ–±—ñ–ª–∏ –Ω–∞ &nbsp;)
      text = text.replace(/  /g, ' &nbsp;');
      
      // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ chip —Ç–µ–≥–∏ –∑ –º–∞—Ä–∫–µ—Ä—ñ–≤ –ü–ï–†–ï–î –æ–±—Ä–æ–±–∫–æ—é –ø—Ä–æ–±—ñ–ª—ñ–≤
      chips.forEach((chipText, index) => {
        const chipHtml = `<span class="chip">${chipText}</span>`;
        text = text.replace(`¬ß¬ß¬ßCHIP${index}¬ß¬ß¬ß`, chipHtml);
      });
      
      // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∑ –º–∞—Ä–∫–µ—Ä—ñ–≤ –ü–ï–†–ï–î –æ–±—Ä–æ–±–∫–æ—é –ø—Ä–æ–±—ñ–ª—ñ–≤
      links.forEach((link, index) => {
        const linkHtml = `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.text}</a>`;
        text = text.replace(`¬ß¬ß¬ßLINK${index}¬ß¬ß¬ß`, linkHtml);
      });
      
      // –í–ê–ñ–õ–ò–í–û: –ó–∞–º—ñ–Ω—é—î–º–æ –ø—Ä–æ–±—ñ–ª–∏ –º—ñ–∂ –∑–∞–∫—Ä–∏–≤–∞—é—á–∏–º —Ç–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—á–∏–º —Ç–µ–≥–∞–º–∏ –Ω–∞ &nbsp;
      text = text.replace(/(<\/[^>]+>)\s+(<[^>]+>)/g, '$1&nbsp;$2');
      
      // –ü–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤
      text = text.replace(/\n/g, '<br>');
      
      return text;
    },
    
    renderCategories() {
      const nav = document.getElementById('categoryNav');
      nav.innerHTML = '';
      
      State.config.categories.forEach(cat => {
        const fieldsCount = State.config.fields.filter(f => f.category === cat.id).length;
        const item = document.createElement('div');
        item.className = 'category-item';
        if (State.ui.activeCategory === cat.id) {
          item.classList.add('active');
        }
        
        item.innerHTML = `
          <div class="category-icon">
            <i class="fas ${cat.icon}"></i>
          </div>
          <div class="category-label">${cat.label}</div>
          <div class="category-count">${fieldsCount}</div>
        `;
        
        item.onclick = () => {
          // –û—á–∏—â—É—î–º–æ –ø–æ—à—É–∫ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
          const searchInput = document.getElementById('searchInput');
          const searchClearBtn = document.getElementById('searchClearBtn');
          if (searchInput && searchInput.value) {
            searchInput.value = '';
            if (searchClearBtn) searchClearBtn.classList.remove('visible');
            Search.query = '';
          }
          
          State.ui.searchActive = false;
          State.ui.activeCategory = cat.id;
          State.ui.lastActiveCategory = cat.id;
          this.renderCategories();
          this.renderContent();
          Progress.update(); // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å –ø—Ä–∏ –∑–º—ñ–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
        };
        
        nav.appendChild(item);
      });
    },
    
    renderContent() {
      const contentTitle = document.getElementById('contentTitle');
      const contentActions = document.getElementById('contentActions');
      const contentBody = document.getElementById('contentBody');
      
      // –†–µ–∂–∏–º –ø–æ—à—É–∫—É
      if (State.ui.searchActive && Search.query) {
        const allFields = State.config.fields;
        const filteredFields = Search.filterFields(allFields);
        
        contentTitle.innerHTML = `
          <i class="fas fa-search"></i>
          <span>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É</span>
        `;
        
        contentActions.innerHTML = '';
        
        if (filteredFields.length === 0) {
          contentBody.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon"><i class="fas fa-search"></i></div>
              <div class="empty-state-text">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
              <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç</p>
            </div>
          `;
          return;
        }
        
        contentBody.innerHTML = '<div class="fields-grid"></div>';
        const grid = contentBody.querySelector('.fields-grid');
        
        filteredFields.forEach(field => {
          grid.appendChild(this.renderField(field, true));
        });
        
        return;
      }
      
      if (!State.ui.activeCategory) {
        contentTitle.innerHTML = `
          <i class="fas fa-hand-pointer"></i>
          <span>–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</span>
        `;
        contentActions.innerHTML = '';
        contentBody.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-hand-pointer"></i></div>
            <div class="empty-state-text">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑–ª—ñ–≤–∞</div>
            <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø–æ–ª—è</p>
          </div>
        `;
        return;
      }
      
      const category = State.config.categories.find(c => c.id === State.ui.activeCategory);
      const fields = State.config.fields.filter(f => f.category === State.ui.activeCategory);
      
      // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø—Ä–∏–≤–∞—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
      const isPrivateCategory = category && category.isPrivate;
      
      contentTitle.innerHTML = `
        <i class="fas ${category.icon}"></i>
        <span>${category.label}</span>
        ${isPrivateCategory ? '<span class="badge badge-high" style="margin-left: 0.5rem;">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞</span>' : ''}
      `;
      
      // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
      const activeFiltersCount = 
        (State.ui.fillFilter !== 'all' ? 1 : 0) + 
        State.ui.importanceFilters.length;
      
      const filtersBadge = activeFiltersCount > 0 
        ? `<span class="filters-badge">${activeFiltersCount}</span>` 
        : '';
      
      contentActions.innerHTML = `
        <button class="filters-toggle-btn" onclick="App.toggleFiltersDropdown()" id="filtersToggleBtn">
          <i class="fas fa-filter"></i>
          <span>–§—ñ–ª—å—Ç—Ä–∏</span>
          ${filtersBadge}
        </button>
        
        <button class="btn btn-secondary btn-sm" onclick="App.editCategory('${category.id}')">
          <i class="fas fa-edit"></i>
          <span>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</span>
        </button>
        
        <div class="filters-dropdown" id="filtersDropdown">
          <div class="filters-dropdown-section">
            <div class="filters-dropdown-label">
              <i class="fas fa-check-square"></i>
              –ó–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å
            </div>
            <div class="fill-filter">
              <button class="fill-filter-btn ${State.ui.fillFilter === 'all' ? 'active' : ''}" onclick="App.setFillFilter('all')">
                <i class="fas fa-list"></i>
                <span>–í—Å—ñ</span>
              </button>
              <button class="fill-filter-btn ${State.ui.fillFilter === 'filled' ? 'active' : ''}" onclick="App.setFillFilter('filled')">
                <i class="fas fa-check-circle"></i>
                <span>–ó–∞–ø–æ–≤–Ω–µ–Ω—ñ</span>
              </button>
              <button class="fill-filter-btn ${State.ui.fillFilter === 'empty' ? 'active' : ''}" onclick="App.setFillFilter('empty')">
                <i class="fas fa-circle"></i>
                <span>–ü–æ—Ä–æ–∂–Ω—ñ</span>
              </button>
            </div>
          </div>
          <div class="filters-dropdown-section">
            <div class="filters-dropdown-label">
              <i class="fas fa-star"></i>
              –í–∞–∂–ª–∏–≤—ñ—Å—Ç—å
            </div>
            <div class="importance-filter">
              <button class="importance-filter-btn ${State.ui.importanceFilters.includes('high') ? 'active high' : ''}" onclick="App.toggleImportanceFilter('high')">
                <i class="fas fa-exclamation-circle"></i>
                <span>–í–∏—Å–æ–∫—ñ</span>
              </button>
              <button class="importance-filter-btn ${State.ui.importanceFilters.includes('medium') ? 'active medium' : ''}" onclick="App.toggleImportanceFilter('medium')">
                <i class="fas fa-minus-circle"></i>
                <span>–°–µ—Ä–µ–¥–Ω—ñ</span>
              </button>
              <button class="importance-filter-btn ${State.ui.importanceFilters.includes('low') ? 'active low' : ''}" onclick="App.toggleImportanceFilter('low')">
                <i class="fas fa-info-circle"></i>
                <span>–ù–∏–∑—å–∫—ñ</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      if (fields.length === 0) {
        contentBody.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
            <div class="empty-state-text">–ù–µ–º–∞—î –ø–æ–ª—ñ–≤ —É —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</div>
            <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ" —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–µ –ø–æ–ª–µ</p>
          </div>
        `;
        return;
      }
      
      // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ–ª—è –∑–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—é
      let filteredFields = fields;
      if (State.ui.fillFilter === 'filled') {
        filteredFields = fields.filter(f => Progress.isFieldFilled(f.id));
      } else if (State.ui.fillFilter === 'empty') {
        filteredFields = fields.filter(f => !Progress.isFieldFilled(f.id));
      }
      
      // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ–ª—è –∑–∞ –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—é
      if (State.ui.importanceFilters.length > 0) {
        filteredFields = filteredFields.filter(f => State.ui.importanceFilters.includes(f.importance));
      }
      
      if (filteredFields.length === 0) {
        let emptyMessage = '–ù–µ–º–∞—î –ø–æ–ª—ñ–≤ –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏';
        if (State.ui.fillFilter !== 'all') {
          const filterText = State.ui.fillFilter === 'filled' ? '–∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö' : '–ø–æ—Ä–æ–∂–Ω—ñ—Ö';
          emptyMessage = `–ù–µ–º–∞—î ${filterText} –ø–æ–ª—ñ–≤ –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏`;
        } else if (State.ui.importanceFilters.length > 0) {
          emptyMessage = '–ù–µ–º–∞—î –ø–æ–ª—ñ–≤ –∑ –æ–±—Ä–∞–Ω–∏–º–∏ —Ä—ñ–≤–Ω—è–º–∏ –≤–∞–∂–ª–∏–≤–æ—Å—Ç—ñ';
        }
        contentBody.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-filter"></i></div>
            <div class="empty-state-text">${emptyMessage}</div>
            <p>–ó–º—ñ–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –Ω–æ–≤—ñ –¥–∞–Ω—ñ</p>
          </div>
        `;
        return;
      }
      
      contentBody.innerHTML = '<div class="fields-grid"></div>';
      const grid = contentBody.querySelector('.fields-grid');
      
      filteredFields.forEach(field => {
        grid.appendChild(this.renderField(field));
      });
    },
    
    renderField(field, showCategory = false) {
      const card = document.createElement('div');
      card.className = 'field-card fade-in';
      
      const value = State.values[field.id];
      const hasValue = value !== undefined && value !== null && value !== '';
      
      let valueHtml = '';
      
      if (field.type === 'nested') {
        if (value && typeof value === 'object') {
          valueHtml = '<div class="nested-container">';
          (field.nestedCategories || []).forEach(cat => {
            valueHtml += `
              <div class="nested-category">
                <div class="nested-category-title">${cat.label}</div>
            `;
            (cat.subcategories || []).forEach(sub => {
              const items = (value[cat.id] && value[cat.id][sub.id]) || [];
              const formattedItems = items.map(item => {
                const formatted = this.formatText(item);
                return Search.query ? Search.highlightText(formatted) : formatted;
              });
              valueHtml += `
                <div class="nested-subcategory">
                  <div class="nested-label">${sub.label}</div>
                  <div class="chips-container">
                    ${formattedItems.length ? formattedItems.map(item => `<div class="chip">${item}</div>`).join('') : '<span class="empty">‚Äî</span>'}
                  </div>
                </div>
              `;
            });
            valueHtml += '</div>';
          });
          valueHtml += '</div>';
        } else {
          valueHtml = '<div class="field-value empty">–ù–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ</div>';
        }
      } else if (field.type === 'tags') {
        const tags = Array.isArray(value) ? value : (value ? value.split(',').map(t => t.trim()) : []);
        const formattedTags = tags.map(tag => {
          const formatted = this.formatText(tag);
          return Search.query ? Search.highlightText(formatted) : formatted;
        });
        valueHtml = `
          <div class="field-value ${tags.length ? '' : 'empty'}">${tags.length ? `<div class="chips-container">${formattedTags.map(tag => `<div class="chip">${tag}</div>`).join('')}</div>`:'–ù–µ–∑–∞–ø–æ–≤–Ω–µ–Ω–æ'}</div>`;
      } else {
        let formattedValue = hasValue ? this.formatText(value) : '–ù–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ';
        if (hasValue && Search.query) {
          formattedValue = Search.highlightText(formattedValue);
        }
        valueHtml = `<div class="field-value ${hasValue ? '' : 'empty'}">${formattedValue}</div>`;
      }
      
      // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –ø–æ–ª—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      let categoryBadge = '';
      if (showCategory) {
        const category = State.config.categories.find(c => c.id === field.category);
        if (category) {
          categoryBadge = `<span class="search-result-badge"><i class="fas ${category.icon}"></i> ${category.label}</span>`;
        }
      }
      
      // Highlight –≤ –Ω–∞–∑–≤—ñ –ø–æ–ª—è
      const highlightedLabel = Search.query ? Search.highlightText(field.label) : field.label;
      
      card.innerHTML = `
        <div class="field-header">
          <div class="field-info">
            <div class="field-label">
              <span>${highlightedLabel}${field.required ? '<span style="color: var(--danger)">*</span>' : ''}</span>
              ${categoryBadge}
            </div>
            <div class="field-meta">
              <span class="badge badge-${field.importance}">${this.getImportanceLabel(field.importance)}</span>
              <span>${this.getTypeLabel(field.type)}</span>
            </div>
          </div>
          <div class="field-controls">
            <button class="btn btn-icon btn-secondary btn-sm field-controls-menu-btn" onclick="App.toggleFieldMenu(event, '${field.id}')" title="–ú–µ–Ω—é">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <button class="btn btn-icon btn-secondary btn-sm" onclick="App.editFieldValue('${field.id}')" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-icon btn-secondary btn-sm" onclick="App.editField('${field.id}')" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–ª—è">
              <i class="fas fa-cog"></i>
            </button>
            <button class="btn btn-icon btn-secondary btn-sm" onclick="App.deleteField('${field.id}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">
              <i class="fas fa-trash"></i>
            </button>
            <div class="field-controls-popup" id="fieldMenu_${field.id}">
              <button class="btn btn-secondary btn-sm" onclick="App.editFieldValue('${field.id}'); App.closeFieldMenu('${field.id}')">
                <i class="fas fa-edit"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
              </button>
              <button class="btn btn-secondary btn-sm" onclick="App.editField('${field.id}'); App.closeFieldMenu('${field.id}')">
                <i class="fas fa-cog"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
              </button>
              <button class="btn btn-danger btn-sm" onclick="App.deleteField('${field.id}'); App.closeFieldMenu('${field.id}')">
                <i class="fas fa-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏
              </button>
            </div>
          </div>
        </div>
        ${valueHtml}
      `;
      
      return card;
    },
    
    getImportanceLabel(importance) {
      const labels = {
        high: '<i class="fas fa-exclamation-circle"></i> –í–∏—Å–æ–∫–∏–π',
        medium: '<i class="fas fa-minus-circle"></i> –°–µ—Ä–µ–¥–Ω—ñ–π',
        low: '<i class="fas fa-info-circle"></i> –ù–∏–∑—å–∫–∏–π'
      };
      return labels[importance] || importance;
    },
    
    getTypeLabel(type) {
      const labels = {
        text: '–¢–µ–∫—Å—Ç',
        textarea: '–¢–µ–∫—Å—Ç–æ–≤–∞ –æ–±–ª–∞—Å—Ç—å',
        date: '–î–∞—Ç–∞',
        tags: '–¢–µ–≥–∏',
        nested: '–í–∫–ª–∞–¥–µ–Ω—ñ'
      };
      return labels[type] || type;
    }
  };

  // ============= APP =============
  const App = {
    async init() {
      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –°–ü–û–ß–ê–¢–ö–£
      await SyncManager.init();
      
      // Load data
      const saved = await Storage.load();
      if (saved) {
        // Merge existing config with new default categories and fields
        const existingCategoryIds = saved.config.categories.map(c => c.id);
        const existingFieldIds = saved.config.fields.map(f => f.id);
        
        // Add new categories that don't exist
        const newCategories = DefaultConfig.categories.filter(c => !existingCategoryIds.includes(c.id));
        const newFields = DefaultConfig.fields.filter(f => !existingFieldIds.includes(f.id));
        
        State.config = {
          categories: [...saved.config.categories, ...newCategories],
          fields: [...saved.config.fields, ...newFields]
        };
        State.values = saved.values;
        
        // Save updated config if new items were added
        if (newCategories.length > 0 || newFields.length > 0) {
          await Storage.save();
        }
      } else {
        State.config = {
          categories: [...DefaultConfig.categories],
          fields: [...DefaultConfig.fields]
        };
        State.values = {...DefaultConfig.values};
        await Storage.save();
      }
      
      // Initialize UI
      Modal.init();
      FormatMenu.init();
      Search.init();
      this.bindEvents();
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é "–ë–∞–∑–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è" –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
      State.ui.activeCategory = 'base';
      State.ui.lastActiveCategory = 'base';
      
      Renderer.renderCategories();
      Renderer.renderContent();
      Progress.update(); // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    },
    
    bindEvents() {
      // Sidebar toggle –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      
      if (sidebarToggle) {
        // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º sidebar –∑–≥–æ—Ä–Ω—É—Ç–∏–π –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö —ñ –º–æ–±—ñ–ª—å–Ω–∏—Ö
        if (window.innerWidth <= 1024) {
          sidebar.classList.add('collapsed');
        }
        
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          sidebarToggle.classList.toggle('active');
        });
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
        window.addEventListener('resize', () => {
          if (window.innerWidth > 1024) {
            sidebar.classList.remove('collapsed');
            sidebarToggle.classList.remove('active');
          }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–æ—Ä—Ç–∞—î–º–æ sidebar –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
        document.getElementById('categoryNav').addEventListener('click', (e) => {
          if (e.target.closest('.category-item') && window.innerWidth <= 1024) {
            sidebar.classList.add('collapsed');
            sidebarToggle.classList.remove('active');
          }
        });
      }
      
      document.getElementById('btnSave').onclick = async () => {
        await Storage.save();
        if (State.sync.mode === 'localStorage') {
          Toast.show('‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
        }
      };
      
      document.getElementById('btnSync').onclick = () => {
        this.openSyncSettings();
      };
      
      document.getElementById('btnExport').onclick = () => {
        const data = JSON.stringify({config: State.config, values: State.values}, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dossier_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        Toast.show('üìÅ –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ');
      };
      
      document.getElementById('btnImport').onclick = () => {
        document.getElementById('fileInput').click();
      };
      
      document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.config && data.values) {
              State.config = data.config;
              State.values = data.values;
              SyncManager.markDirty(); // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –∑–º—ñ–Ω–∏
              await Storage.save();
              Renderer.renderCategories();
              Renderer.renderContent();
              Toast.show('‚úÖ –Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ');
            } else {
              Toast.show('‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É');
            }
          } catch (error) {
            Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      };
      
      document.getElementById('btnClear').onclick = () => {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ? –¶—è –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞!')) {
          Storage.clear();
          State.config = {
            categories: [...DefaultConfig.categories],
            fields: [...DefaultConfig.fields]
          };
          State.values = {...DefaultConfig.values};
          State.ui.activeCategory = null;
          Renderer.renderCategories();
          Renderer.renderContent();
          Toast.show('üóëÔ∏è –î–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ');
        }
      };
      
      document.getElementById('btnAddField').onclick = () => {
        this.showFieldModal();
      };
      
      document.getElementById('btnAddCategory').onclick = () => {
        this.showCategoryModal();
      };
    },
    
    showFieldModal(fieldId = null) {
      const field = fieldId ? State.config.fields.find(f => f.id === fieldId) : null;
      const isEdit = !!field;
      
      const categories = State.config.categories.map(c => 
        `<option value="${c.id}" ${field && field.category === c.id ? 'selected' : ''}>${c.label}</option>`
      ).join('');
      
      Modal.open(
        isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–ª–µ' : '–ù–æ–≤–µ –ø–æ–ª–µ',
        `
          <div class="form-group">
            <label class="form-label">ID –ø–æ–ª—è</label>
            <input type="text" class="form-input" id="fieldId" value="${field ? field.id : ''}" ${isEdit ? 'readonly' : ''} required>
          </div>
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞ –ø–æ–ª—è</label>
            <input type="text" class="form-input" id="fieldLabel" value="${field ? field.label : ''}" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">–¢–∏–ø</label>
              <select class="form-select" id="fieldType">
                <option value="text" ${field && field.type === 'text' ? 'selected' : ''}>–¢–µ–∫—Å—Ç</option>
                <option value="textarea" ${field && field.type === 'textarea' ? 'selected' : ''}>–¢–µ–∫—Å—Ç–æ–≤–∞ –æ–±–ª–∞—Å—Ç—å</option>
                <option value="date" ${field && field.type === 'date' ? 'selected' : ''}>–î–∞—Ç–∞</option>
                <option value="tags" ${field && field.type === 'tags' ? 'selected' : ''}>–¢–µ–≥–∏</option>
                <option value="nested" ${field && field.type === 'nested' ? 'selected' : ''}>–í–∫–ª–∞–¥–µ–Ω—ñ</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–í–∞–∂–ª–∏–≤—ñ—Å—Ç—å</label>
              <select class="form-select" id="fieldImportance">
                <option value="high" ${field && field.importance === 'high' ? 'selected' : ''}>–í–∏—Å–æ–∫–∞</option>
                <option value="medium" ${field && field.importance === 'medium' ? 'selected' : ''}>–°–µ—Ä–µ–¥–Ω—è</option>
                <option value="low" ${field && field.importance === 'low' ? 'selected' : ''}>–ù–∏–∑—å–∫–∞</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <select class="form-select" id="fieldCategory">
              ${categories}
            </select>
          </div>
          <div class="form-checkbox">
            <input type="checkbox" id="fieldRequired" ${field && field.required ? 'checked' : ''}>
            <label for="fieldRequired">–û–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ</label>
          </div>
        `,
        {
          icon: 'fa-plus-circle',
          onSave: async () => {
            const id = document.getElementById('fieldId').value.trim();
            const label = document.getElementById('fieldLabel').value.trim();
            const type = document.getElementById('fieldType').value;
            const importance = document.getElementById('fieldImportance').value;
            const category = document.getElementById('fieldCategory').value;
            const required = document.getElementById('fieldRequired').checked;
            
            if (!id || !label) {
              Toast.show('‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
              return false;
            }
            
            if (!isEdit && State.config.fields.find(f => f.id === id)) {
              Toast.show('‚ùå –ü–æ–ª–µ –∑ —Ç–∞–∫–∏–º ID –≤–∂–µ —ñ—Å–Ω—É—î');
              return false;
            }
            
            const fieldData = {id, label, type, importance, category, required};
            
            if (type === 'nested') {
              fieldData.nestedCategories = field && field.nestedCategories ? field.nestedCategories : [];
            }
            
            if (isEdit) {
              const index = State.config.fields.findIndex(f => f.id === fieldId);
              State.config.fields[index] = fieldData;
            } else {
              State.config.fields.push(fieldData);
            }
            
            SyncManager.markDirty(); // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –∑–º—ñ–Ω–∏
            await Storage.save();
            Renderer.renderContent();
            Progress.update();
            Toast.show(isEdit ? '‚úÖ –ü–æ–ª–µ –æ–Ω–æ–≤–ª–µ–Ω–æ' : '‚úÖ –ü–æ–ª–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ');
            return true;
          },
          onOpen: () => {
            // Initialize custom selects
            setTimeout(() => {
              const typeSelect = document.getElementById('fieldType');
              if (typeSelect) {
                CustomSelect.init(typeSelect, [
                  {value: 'text', label: '–¢–µ–∫—Å—Ç', icon: 'fa-font', selected: field && field.type === 'text'},
                  {value: 'textarea', label: '–¢–µ–∫—Å—Ç–æ–≤–∞ –æ–±–ª–∞—Å—Ç—å', icon: 'fa-align-left', selected: field && field.type === 'textarea'},
                  {value: 'date', label: '–î–∞—Ç–∞', icon: 'fa-calendar', selected: field && field.type === 'date'},
                  {value: 'tags', label: '–¢–µ–≥–∏', icon: 'fa-tags', selected: field && field.type === 'tags'},
                  {value: 'nested', label: '–í–∫–ª–∞–¥–µ–Ω—ñ', icon: 'fa-layer-group', selected: field && field.type === 'nested'}
                ]);
              }
              
              const importanceSelect = document.getElementById('fieldImportance');
              if (importanceSelect) {
                CustomSelect.init(importanceSelect, [
                  {value: 'high', label: '–í–∏—Å–æ–∫–∞', icon: 'fa-exclamation-circle', selected: field && field.importance === 'high'},
                  {value: 'medium', label: '–°–µ—Ä–µ–¥–Ω—è', icon: 'fa-minus-circle', selected: field && field.importance === 'medium'},
                  {value: 'low', label: '–ù–∏–∑—å–∫–∞', icon: 'fa-info-circle', selected: field && field.importance === 'low'}
                ]);
              }
              
              const categorySelect = document.getElementById('fieldCategory');
              if (categorySelect) {
                const categoryOptions = State.config.categories.map(c => ({
                  value: c.id,
                  label: c.label,
                  icon: c.icon || 'fa-folder',
                  selected: field && field.category === c.id
                }));
                CustomSelect.init(categorySelect, categoryOptions);
              }
            }, 100);
          }
        }
      );
    },
    
    showCategoryModal(categoryId = null) {
      const category = categoryId ? State.config.categories.find(c => c.id === categoryId) : null;
      const isEdit = !!category;
      
      Modal.open(
        isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é' : '–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è',
        `
          <div class="form-group">
            <label class="form-label">ID –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
            <input type="text" class="form-input" id="catId" value="${category ? category.id : ''}" ${isEdit ? 'readonly' : ''} required>
          </div>
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
            <input type="text" class="form-input" id="catLabel" value="${category ? category.label : ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">–Ü–∫–æ–Ω–∫–∞ (Font Awesome)</label>
            <input type="text" class="form-input" id="catIcon" value="${category ? category.icon : 'fa-folder'}" placeholder="fa-folder">
          </div>
        `,
        {
          icon: 'fa-folder',
          onSave: async () => {
            const id = document.getElementById('catId').value.trim();
            const label = document.getElementById('catLabel').value.trim();
            const icon = document.getElementById('catIcon').value.trim() || 'fa-folder';
            
            if (!id || !label) {
              Toast.show('‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
              return false;
            }
            
            if (!isEdit && State.config.categories.find(c => c.id === id)) {
              Toast.show('‚ùå –ö–∞—Ç–µ–≥–æ—Ä—ñ—è –∑ —Ç–∞–∫–∏–º ID –≤–∂–µ —ñ—Å–Ω—É—î');
              return false;
            }
            
            if (isEdit) {
              const index = State.config.categories.findIndex(c => c.id === categoryId);
              State.config.categories[index] = {id, label, icon};
            } else {
              State.config.categories.push({id, label, icon});
            }
            
            SyncManager.markDirty(); // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –∑–º—ñ–Ω–∏
            await Storage.save();
            Renderer.renderCategories();
            Toast.show(isEdit ? '‚úÖ –ö–∞—Ç–µ–≥–æ—Ä—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–æ' : '‚úÖ –ö–∞—Ç–µ–≥–æ—Ä—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ');
            return true;
          }
        }
      );
    },
    
    editFieldValue(fieldId) {
      const field = State.config.fields.find(f => f.id === fieldId);
      if (!field) return;
      
      const value = State.values[fieldId];
      
      let contentHtml = '';
      
      if (field.type === 'text' || field.type === 'date') {
        contentHtml = `
          <div class="form-group">
            <label class="form-label">${field.label}</label>
            <input type="${field.type}" class="form-input" id="fieldValue" value="${value || ''}">
            ${field.type === 'text' ? '<small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">üí° –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: **–∂–∏—Ä–Ω–∏–π**, *–∫—É—Ä—Å–∏–≤*, ~~–∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π~~, [—Ç–µ–∫—Å—Ç](url)<br>üé® –í–∏–¥—ñ–ª—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è</small>' : ''}
          </div>
        `;
      } else if (field.type === 'textarea') {
        contentHtml = `
          <div class="form-group">
            <label class="form-label">${field.label}</label>
            <textarea class="form-textarea" id="fieldValue">${value || ''}</textarea>
            <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">üí° –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: **–∂–∏—Ä–Ω–∏–π**, *–∫—É—Ä—Å–∏–≤*, ~~–∑–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π~~, [—Ç–µ–∫—Å—Ç](url)<br>üé® –í–∏–¥—ñ–ª—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è</small>
          </div>
        `;
      } else if (field.type === 'tags') {
        const tags = Array.isArray(value) ? value.join(', ') : (value || '');
        contentHtml = `
          <div class="form-group">
            <label class="form-label">${field.label}</label>
            <input type="text" class="form-input" id="fieldValue" value="${tags}" placeholder="—Ç–µ–≥1, —Ç–µ–≥2, —Ç–µ–≥3">
            <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">–†–æ–∑–¥—ñ–ª—è–π—Ç–µ —Ç–µ–≥–∏ –∫–æ–º–∞–º–∏</small>
          </div>
        `;
      } else if (field.type === 'nested') {
        contentHtml = '<div>';
        (field.nestedCategories || []).forEach(cat => {
          contentHtml += `<div style="margin-bottom: 1.5rem;">
            <div style="font-weight: 600; margin-bottom: 0.75rem;">${cat.label}</div>`;
          (cat.subcategories || []).forEach(sub => {
            const val = (value && value[cat.id] && value[cat.id][sub.id]) ? value[cat.id][sub.id].join(', ') : '';
            contentHtml += `
              <div class="form-group">
                <label class="form-label">${sub.label}</label>
                <input type="text" class="form-input" data-cat="${cat.id}" data-sub="${sub.id}" value="${val}" placeholder="–∑–Ω–∞—á–µ–Ω–Ω—è1, –∑–Ω–∞—á–µ–Ω–Ω—è2">
              </div>
            `;
          });
          contentHtml += '</div>';
        });
        contentHtml += '</div>';
      }
      
      Modal.open(
        `–†–µ–¥–∞–≥—É–≤–∞—Ç–∏: ${field.label}`,
        contentHtml,
        {
          icon: 'fa-edit',
          onSave: async () => {
            if (field.type === 'nested') {
              const newValue = {};
              (field.nestedCategories || []).forEach(cat => {
                newValue[cat.id] = {};
                (cat.subcategories || []).forEach(sub => {
                  const input = Modal.body.querySelector(`[data-cat="${cat.id}"][data-sub="${sub.id}"]`);
                  if (input && input.value) {
                    newValue[cat.id][sub.id] = input.value.split(',').map(v => v.trim()).filter(Boolean);
                  } else {
                    newValue[cat.id][sub.id] = [];
                  }
                });
              });
              State.values[fieldId] = newValue;
            } else if (field.type === 'tags') {
              const input = document.getElementById('fieldValue');
              State.values[fieldId] = input.value.split(',').map(v => v.trim()).filter(Boolean);
            } else {
              const input = document.getElementById('fieldValue');
              State.values[fieldId] = input.value;
            }
            
            // –ü–æ–∑–Ω–∞—á–∞—î–º–æ —â–æ —î –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏
            SyncManager.markDirty();
            
            await Storage.save();
            Renderer.renderContent();
            Progress.update();
            Toast.show('‚úÖ –ó–Ω–∞—á–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ');
            return true;
          }
        }
      );
    },
    
    editField(fieldId) {
      this.showFieldModal(fieldId);
    },
    
    editCategory(categoryId) {
      this.showCategoryModal(categoryId);
    },
    
    toggleFieldMenu(event, fieldId) {
      event.stopPropagation();
      const menu = document.getElementById(`fieldMenu_${fieldId}`);
      const allMenus = document.querySelectorAll('.field-controls-popup');
      
      // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—Å—ñ —ñ–Ω—à—ñ –º–µ–Ω—é
      allMenus.forEach(m => {
        if (m !== menu) m.classList.remove('active');
      });
      
      // Toggle –ø–æ—Ç–æ—á–Ω–µ –º–µ–Ω—é
      menu.classList.toggle('active');
      
      // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target)) {
              menu.classList.remove('active');
              document.removeEventListener('click', closeMenu);
            }
          });
        }, 0);
      }
    },
    
    closeFieldMenu(fieldId) {
      const menu = document.getElementById(`fieldMenu_${fieldId}`);
      if (menu) menu.classList.remove('active');
    },
    
    async deleteField(fieldId) {
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–ª–µ?')) return;
      
      State.config.fields = State.config.fields.filter(f => f.id !== fieldId);
      delete State.values[fieldId];
      SyncManager.markDirty(); // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –∑–º—ñ–Ω–∏
      await Storage.save();
      Renderer.renderContent();
      Progress.update();
      Toast.show('üóëÔ∏è –ü–æ–ª–µ –≤–∏–¥–∞–ª–µ–Ω–æ');
    },
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î —Ñ—ñ–ª—å—Ç—Ä –∑–∞–ø–æ–≤–Ω–µ–Ω–æ—Å—Ç—ñ
    setFillFilter(filter) {
      State.ui.fillFilter = filter;
      Renderer.renderContent();
      Progress.update();
      
      const filterNames = {
        all: '–≤—Å—ñ –ø–æ–ª—è',
        filled: '–∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –ø–æ–ª—è',
        empty: '–ø–æ—Ä–æ–∂–Ω—ñ –ø–æ–ª—è'
      };
      Toast.show(`üìä –ü–æ–∫–∞–∑–∞–Ω–æ: ${filterNames[filter]}`);
      
      // –û–Ω–æ–≤–ª—é—î–º–æ badge
      this.updateFiltersBadge();
    },
    
    // Toggle filters dropdown
    toggleFiltersDropdown() {
      const dropdown = document.getElementById('filtersDropdown');
      const toggleBtn = document.getElementById('filtersToggleBtn');
      
      if (!dropdown || !toggleBtn) return;
      
      const isActive = dropdown.classList.contains('active');
      
      if (isActive) {
        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
        dropdown.classList.remove('active');
        dropdown.classList.add('closing');
        toggleBtn.classList.remove('active');
        
        setTimeout(() => {
          dropdown.classList.remove('closing');
        }, 200);
      } else {
        // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ
        dropdown.classList.add('active');
        toggleBtn.classList.add('active');
        
        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ dropdown –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
        setTimeout(() => {
          document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
              dropdown.classList.remove('active');
              dropdown.classList.add('closing');
              toggleBtn.classList.remove('active');
              document.removeEventListener('click', closeDropdown);
              
              setTimeout(() => {
                dropdown.classList.remove('closing');
              }, 200);
            }
          });
        }, 0);
      }
    },
    
    // Toggle —Ñ—ñ–ª—å—Ç—Ä –≤–∞–∂–ª–∏–≤–æ—Å—Ç—ñ (–º–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä)
    toggleImportanceFilter(importance) {
      const index = State.ui.importanceFilters.indexOf(importance);
      
      if (index > -1) {
        // –í–∏–¥–∞–ª—è—î–º–æ —è–∫—â–æ –≤–∂–µ —î
        State.ui.importanceFilters.splice(index, 1);
      } else {
        // –î–æ–¥–∞—î–º–æ —è–∫—â–æ –Ω–µ–º–∞—î
        State.ui.importanceFilters.push(importance);
      }
      
      Renderer.renderContent();
      Progress.update();
      
      const importanceNames = {
        high: '–≤–∏—Å–æ–∫—ñ',
        medium: '—Å–µ—Ä–µ–¥–Ω—ñ',
        low: '–Ω–∏–∑—å–∫—ñ'
      };
      
      if (State.ui.importanceFilters.length === 0) {
        Toast.show('üîò –ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ–ª—è –≤—Å—ñ—Ö —Ä—ñ–≤–Ω—ñ–≤ –≤–∞–∂–ª–∏–≤–æ—Å—Ç—ñ');
      } else {
        const activeNames = State.ui.importanceFilters.map(i => importanceNames[i]).join(', ');
        Toast.show(`üéØ –§—ñ–ª—å—Ç—Ä: ${activeNames}`);
      }
      
      // –û–Ω–æ–≤–ª—é—î–º–æ badge
      this.updateFiltersBadge();
    },
    
    // Toggle header menu dropdown
    toggleHeaderMenu() {
      const dropdown = document.getElementById('headerMenuDropdown');
      const toggleBtn = document.getElementById('headerMenuBtn');
      
      if (!dropdown || !toggleBtn) return;
      
      const isActive = dropdown.classList.contains('active');
      
      if (isActive) {
        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
        dropdown.classList.remove('active');
        dropdown.classList.add('closing');
        toggleBtn.classList.remove('active');
        
        setTimeout(() => {
          dropdown.classList.remove('closing');
        }, 200);
      } else {
        // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ
        dropdown.classList.add('active');
        toggleBtn.classList.add('active');
        
        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ dropdown –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
        setTimeout(() => {
          document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
              dropdown.classList.remove('active');
              dropdown.classList.add('closing');
              toggleBtn.classList.remove('active');
              document.removeEventListener('click', closeDropdown);
              
              setTimeout(() => {
                dropdown.classList.remove('closing');
              }, 200);
            }
          });
        }, 0);
      }
    },
    
    // –í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    openSyncSettings() {
      Modal.open('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó', this.renderSyncSettingsModal(), {
        icon: 'fa-sync-alt',
        size: 'large',
        onSave: async () => {
          return await this.saveSyncSettings();
        },
        onOpen: () => {
          this.initSyncModalListeners();
        }
      });
    },
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è event listeners –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    initSyncModalListeners() {
      // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      document.querySelectorAll('input[name="storageMode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const mode = e.target.value;
          const googleSheetsSettings = document.getElementById('googleSheetsSettings');
          googleSheetsSettings.style.display = mode === 'googleSheets' ? 'block' : 'none';
        });
      });
      
      // –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è checkbox
      const autoSyncCheckbox = document.getElementById('syncAutoSync');
      if (autoSyncCheckbox) {
        autoSyncCheckbox.addEventListener('change', (e) => {
          const intervalRow = document.getElementById('autoSyncIntervalRow');
          intervalRow.style.display = e.target.checked ? 'flex' : 'none';
        });
      }
      
      // –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è checkbox
      const encryptionCheckbox = document.getElementById('syncEncryption');
      if (encryptionCheckbox) {
        encryptionCheckbox.addEventListener('change', (e) => {
          const passwordFields = document.getElementById('encryptionPasswordFields');
          passwordFields.style.display = e.target.checked ? 'block' : 'none';
        });
      }
      
      // Client ID input - –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
      const clientIdInput = document.getElementById('syncClientId');
      const authorizeBtn = document.getElementById('btnAuthorizeGoogle');
      if (clientIdInput && authorizeBtn) {
        clientIdInput.addEventListener('input', (e) => {
          authorizeBtn.disabled = !e.target.value.trim();
        });
      }
      
      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ Google
      if (authorizeBtn) {
        authorizeBtn.addEventListener('click', async () => {
          const clientId = document.getElementById('syncClientId').value.trim();
          if (!clientId) {
            Toast.show('‚ùå –í–≤–µ–¥—ñ—Ç—å Client ID', 'error');
            return;
          }
          
          try {
            Toast.show('‚è≥ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Google API...', 'info');
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Google API
            await GoogleSheetsSync.initGapi();
            await GoogleSheetsSync.initGis(clientId);
            
            // –ê–≤—Ç–æ—Ä–∏–∑—É—î–º–æ—Å—è
            await GoogleSheetsSync.authorize();
            
            Toast.show('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ –≤ Google');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
            document.getElementById('btnCreateSpreadsheet').style.display = 'inline-flex';
          } catch (error) {
            console.error('Authorization error:', error);
            Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: ' + error.message, 'error');
          }
        });
      }
      
      // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
      const createSpreadsheetBtn = document.getElementById('btnCreateSpreadsheet');
      if (createSpreadsheetBtn) {
        createSpreadsheetBtn.addEventListener('click', async () => {
          try {
            Toast.show('‚è≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ...', 'info');
            
            const result = await GoogleSheetsSync.createSpreadsheet();
            
            State.sync.googleSheets.spreadsheetId = result.spreadsheetId;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ UI
            document.getElementById('syncSpreadsheetId').value = result.spreadsheetId;
            document.getElementById('spreadsheetIdRow').style.display = 'flex';
            document.getElementById('btnOpenSpreadsheet').style.display = 'inline-flex';
            document.getElementById('migrationSection').style.display = 'block';
            
            Toast.show('‚úÖ –¢–∞–±–ª–∏—Ü—é —Å—Ç–≤–æ—Ä–µ–Ω–æ! <a href="' + result.url + '" target="_blank">–í—ñ–¥–∫—Ä–∏—Ç–∏</a>');
          } catch (error) {
            console.error('Create spreadsheet error:', error);
            Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ: ' + error.message, 'error');
          }
        });
      }
      
      // –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é
      const openSpreadsheetBtn = document.getElementById('btnOpenSpreadsheet');
      if (openSpreadsheetBtn) {
        openSpreadsheetBtn.addEventListener('click', () => {
          const spreadsheetId = State.sync.googleSheets.spreadsheetId;
          if (spreadsheetId) {
            window.open(`https://docs.google.com/spreadsheets/d/${spreadsheetId}`, '_blank');
          }
        });
      }
      
      // –ï–∫—Å–ø–æ—Ä—Ç Local ‚Üí Google Sheets
      const uploadBtn = document.getElementById('btnUploadToSheets');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', async () => {
          if (!GoogleSheetsSync.isAuthorized()) {
            Toast.show('‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ Google', 'error');
            return;
          }
          
          try {
            Toast.show('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...', 'info');
            
            const password = State.sync.googleSheets.encryptionEnabled ? 
              sessionStorage.getItem('encryption_password') : null;
            
            await GoogleSheetsSync.uploadData(State.config, State.values, password);
            
            State.sync.googleSheets.lastSync = new Date().toISOString();
            Storage.saveSyncSettings();
            
            Toast.show('‚úÖ –î–∞–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –≤ Google Sheets');
          } catch (error) {
            console.error('Upload error:', error);
            Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É: ' + error.message, 'error');
          }
        });
      }
      
      // –Ü–º–ø–æ—Ä—Ç Google Sheets ‚Üí Local
      const downloadBtn = document.getElementById('btnDownloadFromSheets');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', async () => {
          if (!GoogleSheetsSync.isAuthorized()) {
            Toast.show('‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ Google', 'error');
            return;
          }
          
          try {
            Toast.show('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...', 'info');
            
            const password = State.sync.googleSheets.encryptionEnabled ? 
              sessionStorage.getItem('encryption_password') : null;
            
            const result = await GoogleSheetsSync.downloadData(password);
            
            State.config = result.config;
            State.values = result.values;
            
            // –ù–ï –ø–æ–∑–Ω–∞—á–∞—î–º–æ —è–∫ dirty - —Ü–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ!
            SyncManager.hasUnsyncedChanges = false;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ localStorage —è–∫ backup
            await Storage.save();
            
            // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—é—î–º–æ UI
            Renderer.renderCategories();
            Renderer.renderContent();
            Progress.update();
            
            Toast.show('‚úÖ –î–∞–Ω—ñ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –∑ Google Sheets');
          } catch (error) {
            console.error('Download error:', error);
            Toast.show('‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' + error.message, 'error');
          }
        });
      }
      
      // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑–∞—Ä–∞–∑
      const syncNowBtn = document.getElementById('btnSyncNow');
      if (syncNowBtn) {
        syncNowBtn.addEventListener('click', async () => {
          await SyncManager.manualSync();
        });
      }
    },
    
    // –†–µ–Ω–¥–µ—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    renderSyncSettingsModal() {
      const currentMode = State.sync.mode;
      const gs = State.sync.googleSheets;
      
      return `
        <!-- –†–æ–∑–¥—ñ–ª 1: –†–µ–∂–∏–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è -->
        <div class="settings-section">
          <div class="settings-section-title">
            <i class="fas fa-database"></i>
            –†–µ–∂–∏–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
          </div>
          
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="storageMode" value="localStorage" ${currentMode === 'localStorage' ? 'checked' : ''}>
              <div class="radio-option-content">
                <span class="radio-option-label">üíæ Local Storage</span>
                <span class="radio-option-desc">–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ. –®–≤–∏–¥–∫–æ —Ç–∞ –ø—Ä–æ—Å—Ç–æ, –∞–ª–µ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –º—ñ–∂ –ø—Ä–∏—Å—Ç—Ä–æ—è–º–∏.</span>
              </div>
            </label>
            
            <label class="radio-option">
              <input type="radio" name="storageMode" value="googleSheets" ${currentMode === 'googleSheets' ? 'checked' : ''}>
              <div class="radio-option-content">
                <span class="radio-option-label">‚òÅÔ∏è Google Sheets</span>
                <span class="radio-option-desc">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Google —Ç–∞–±–ª–∏—Ü–µ—é. –î–æ—Å—Ç—É–ø –∑ –±—É–¥—å-—è–∫–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.</span>
              </div>
            </label>
            
            <label class="radio-option">
              <input type="radio" name="storageMode" value="manual" ${currentMode === 'manual' ? 'checked' : ''}>
              <div class="radio-option-content">
                <span class="radio-option-label">üìÅ –†—É—á–Ω—ñ —Ñ–∞–π–ª–∏</span>
                <span class="radio-option-desc">–Ü–º–ø–æ—Ä—Ç/–ï–∫—Å–ø–æ—Ä—Ç JSON —Ñ–∞–π–ª—ñ–≤. –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–∞–Ω–∏–º–∏.</span>
              </div>
            </label>
          </div>
        </div>
        
        <!-- –†–æ–∑–¥—ñ–ª 2: Google Sheets –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -->
        <div class="settings-section" id="googleSheetsSettings" style="display: ${currentMode === 'googleSheets' ? 'block' : 'none'}">
          <div class="settings-section-title">
            <i class="fab fa-google"></i>
            Google Sheets –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
          </div>
          
          <!-- –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è -->
          <div class="instruction-block">
            <div class="instruction-toggle" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('show')">
              <i class="fas fa-chevron-down"></i>
              <span>–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span>
            </div>
            <div class="instruction-content">
              <h4>–ö—Ä–æ–∫ 1: Google Cloud Console</h4>
              <ol>
                <li>–ü–µ—Ä–µ–π–¥—ñ—Ç—å: <code>https://console.cloud.google.com</code></li>
                <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "New Project"</li>
                <li>–ù–∞–∑–≤–∞: "My Dossier" (–∞–±–æ –±—É–¥—å-—è–∫–∞)</li>
                <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Create"</li>
              </ol>
              
              <h4>–ö—Ä–æ–∫ 2: –£–≤—ñ–º–∫–Ω—É—Ç–∏ API</h4>
              <ol>
                <li>–ú–µ–Ω—é ‚Üí "APIs & Services" ‚Üí "Library"</li>
                <li>–ó–Ω–∞–π–¥—ñ—Ç—å "Google Sheets API"</li>
                <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Enable"</li>
              </ol>
              
              <h4>–ö—Ä–æ–∫ 3: –°—Ç–≤–æ—Ä–∏—Ç–∏ OAuth Client</h4>
              <ol>
                <li>"APIs & Services" ‚Üí "Credentials"</li>
                <li>"Create Credentials" ‚Üí "OAuth client ID"</li>
                <li>Application type: "Web application"</li>
                <li>Name: "Love Dossier"</li>
                <li>Authorized JavaScript origins: –≤–∞—à –¥–æ–º–µ–Ω</li>
                <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Create"</li>
                <li><strong>–°–ö–û–ü–Ü–Æ–ô–¢–ï Client ID</strong></li>
              </ol>
            </div>
          </div>
          
          <div class="sync-settings-group">
            <div class="form-row">
              <label class="form-label">Client ID:</label>
              <input type="text" class="form-input" id="syncClientId" value="${gs.clientId || ''}" placeholder="1234567890-abc123...">
            </div>
            
            <div class="form-row" id="spreadsheetIdRow" style="display: ${gs.spreadsheetId ? 'flex' : 'none'}">
              <label class="form-label">Spreadsheet ID:</label>
              <input type="text" class="form-input" id="syncSpreadsheetId" value="${gs.spreadsheetId || ''}" readonly>
            </div>
            
            <div class="sync-buttons">
              <button class="btn btn-secondary btn-sm" id="btnAuthorizeGoogle" ${!gs.clientId ? 'disabled' : ''}>
                <i class="fas fa-sign-in-alt"></i> –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Google
              </button>
              
              <button class="btn btn-secondary btn-sm" id="btnCreateSpreadsheet" style="display: none">
                <i class="fas fa-plus"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É —Ç–∞–±–ª–∏—Ü—é
              </button>
              
              <button class="btn btn-secondary btn-sm" id="btnOpenSpreadsheet" style="display: ${gs.spreadsheetId ? 'inline-flex' : 'none'}">
                <i class="fas fa-external-link-alt"></i> –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é
              </button>
            </div>
            
            <div class="form-row">
              <label class="checkbox-label">
                <input type="checkbox" id="syncAutoSync" ${gs.autoSyncEnabled ? 'checked' : ''}>
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
              </label>
            </div>
            
            <div class="form-row" id="autoSyncIntervalRow" style="display: ${gs.autoSyncEnabled ? 'flex' : 'none'}">
              <label class="form-label">–Ü–Ω—Ç–µ—Ä–≤–∞–ª:</label>
              <select class="form-input" id="syncInterval">
                <option value="1" ${gs.autoSyncInterval === 1 ? 'selected' : ''}>1 —Ö–≤–∏–ª–∏–Ω–∞</option>
                <option value="5" ${gs.autoSyncInterval === 5 ? 'selected' : ''}>5 —Ö–≤–∏–ª–∏–Ω</option>
                <option value="15" ${gs.autoSyncInterval === 15 ? 'selected' : ''}>15 —Ö–≤–∏–ª–∏–Ω</option>
                <option value="30" ${gs.autoSyncInterval === 30 ? 'selected' : ''}>30 —Ö–≤–∏–ª–∏–Ω</option>
                <option value="60" ${gs.autoSyncInterval === 60 ? 'selected' : ''}>1 –≥–æ–¥–∏–Ω–∞</option>
              </select>
            </div>
            
            <div class="form-row">
              <label class="checkbox-label">
                <input type="checkbox" id="syncEncryption" ${gs.encryptionEnabled ? 'checked' : ''}>
                –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
              </label>
            </div>
            
            <div id="encryptionPasswordFields" style="display: ${gs.encryptionEnabled ? 'block' : 'none'}">
              <div class="form-row">
                <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                <div class="password-input-group">
                  <input type="password" class="form-input" id="syncPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                  <button type="button" class="password-toggle" onclick="this.previousElementSibling.type = this.previousElementSibling.type === 'password' ? 'text' : 'password'">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </div>
              
              <div class="form-row">
                <label class="form-label">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è:</label>
                <div class="password-input-group">
                  <input type="password" class="form-input" id="syncPasswordConfirm" placeholder="–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                  <button type="button" class="password-toggle" onclick="this.previousElementSibling.type = this.previousElementSibling.type === 'password' ? 'text' : 'password'">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </div>
              
              <p style="font-size: 0.75rem; color: var(--danger); margin-top: 0.5rem;">
                ‚ö†Ô∏è <strong>–ü–∞—Ä–æ–ª—å –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è!</strong> –ó–∞–ø–∏—à—ñ—Ç—å –π–æ–≥–æ –≤ –±–µ–∑–ø–µ—á–Ω–æ–º—É –º—ñ—Å—Ü—ñ.
              </p>
            </div>
          </div>
          
          <!-- Security Notice -->
          <div class="security-notice">
            <div class="security-notice-title">
              <i class="fas fa-shield-alt"></i>
              –ü—Ä–æ –≤–∞—à—É –±–µ–∑–ø–µ–∫—É
            </div>
            <ul>
              <li>–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –í–ê–®–Ü–ô Google —Ç–∞–±–ª–∏—Ü—ñ</li>
              <li>–ú–∏ –ù–ï –º–∞—î–º–æ –¥–æ—Å—Ç—É–ø—É –¥–æ –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö</li>
              <li>–¢–æ–∫–µ–Ω–∏ –¥–æ—Å—Ç—É–ø—É —Ç—ñ–ª—å–∫–∏ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ</li>
              <li>–ó —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è–º –¥–∞–Ω—ñ –Ω–µ—á–∏—Ç–∞–±–µ–ª—å–Ω—ñ –±–µ–∑ –ø–∞—Ä–æ–ª—è</li>
              <li>–í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥–∫–ª–∏–∫–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –±—É–¥—å-–∫–æ–ª–∏</li>
            </ul>
          </div>
        </div>
        
        <!-- –†–æ–∑–¥—ñ–ª 3: –ú—ñ–≥—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö -->
        <div class="settings-section" id="migrationSection" style="display: ${gs.spreadsheetId ? 'block' : 'none'}">
          <div class="settings-section-title">
            <i class="fas fa-exchange-alt"></i>
            –ú—ñ–≥—Ä–∞—Ü—ñ—è —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </div>
          
          <div class="sync-buttons">
            <button class="btn btn-secondary btn-sm" id="btnUploadToSheets">
              <i class="fas fa-cloud-upload-alt"></i> –ï–∫—Å–ø–æ—Ä—Ç Local ‚Üí Google Sheets
            </button>
            
            <button class="btn btn-secondary btn-sm" id="btnDownloadFromSheets">
              <i class="fas fa-cloud-download-alt"></i> –Ü–º–ø–æ—Ä—Ç Google Sheets ‚Üí Local
            </button>
            
            <button class="btn btn-primary btn-sm" id="btnSyncNow">
              <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑–∞—Ä–∞–∑
            </button>
          </div>
          
          <div class="sync-stats">
            <div class="sync-stat-item">
              <div class="sync-stat-label">–ü–æ–ª—ñ–≤ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ</div>
              <div class="sync-stat-value">${Object.keys(State.values).length}</div>
            </div>
            <div class="sync-stat-item">
              <div class="sync-stat-label">–û—Å—Ç–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è</div>
              <div class="sync-stat-value">${gs.lastSync ? new Date(gs.lastSync).toLocaleString('uk-UA') : '–ù—ñ–∫–æ–ª–∏'}</div>
            </div>
          </div>
        </div>
      `;
    },
    
    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
    async saveSyncSettings() {
      const mode = document.querySelector('input[name="storageMode"]:checked')?.value || 'localStorage';
      const oldMode = State.sync.mode;
      
      State.sync.mode = mode;
      
      if (mode === 'googleSheets') {
        const clientId = document.getElementById('syncClientId')?.value.trim();
        const autoSync = document.getElementById('syncAutoSync')?.checked;
        const interval = parseInt(document.getElementById('syncInterval')?.value) || 5;
        const encryption = document.getElementById('syncEncryption')?.checked;
        
        if (!clientId) {
          Toast.show('‚ùå –í–≤–µ–¥—ñ—Ç—å Client ID', 'error');
          return false;
        }
        
        State.sync.googleSheets.clientId = clientId;
        State.sync.googleSheets.autoSyncEnabled = autoSync;
        State.sync.googleSheets.autoSyncInterval = interval;
        State.sync.googleSheets.encryptionEnabled = encryption;
        
        // –Ø–∫—â–æ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–µ, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–∞—Ä–æ–ª—å
        if (encryption) {
          const password = document.getElementById('syncPassword')?.value;
          const passwordConfirm = document.getElementById('syncPasswordConfirm')?.value;
          
          if (!password || password.length < 6) {
            Toast.show('‚ùå –ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤', 'error');
            return false;
          }
          
          if (password !== passwordConfirm) {
            Toast.show('‚ùå –ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å', 'error');
            return false;
          }
          
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ö–µ—à –ø–∞—Ä–æ–ª—è –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
          State.sync.googleSheets.encryptionPasswordHash = await GoogleSheetsSync.encryption.hashPassword(password);
          
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–∞—Ä–æ–ª—å –≤ sessionStorage (–ù–ï –≤ localStorage!)
          sessionStorage.setItem('encryption_password', password);
        }
        
        State.sync.googleSheets.enabled = true;
        
        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        if (autoSync) {
          SyncManager.startAutoSync(interval);
        } else {
          SyncManager.stopAutoSync();
        }
        
        SyncManager.updateStatus('synced', 'Google Sheets');
      } else {
        State.sync.googleSheets.enabled = false;
        SyncManager.stopAutoSync();
        SyncManager.updateStatus('local', 'Local —Ä–µ–∂–∏–º');
      }
      
      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      Storage.saveSyncSettings();
      
      // –Ø–∫—â–æ —Ä–µ–∂–∏–º –∑–º—ñ–Ω–∏–≤—Å—è, –∑–∞–ø–∏—Ç–∞—Ç–∏ –ø—Ä–æ –º—ñ–≥—Ä–∞—Ü—ñ—é
      if (oldMode !== mode && oldMode !== 'localStorage') {
        // TODO: –ø–æ–∫–∞–∑–∞—Ç–∏ –¥—ñ–∞–ª–æ–≥ –º—ñ–≥—Ä–∞—Ü—ñ—ó
      }
      
      Toast.show('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
      return true;
    },
    
    // –û–Ω–æ–≤–ª—é—î badge –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    updateFiltersBadge() {
      const activeFiltersCount = 
        (State.ui.fillFilter !== 'all' ? 1 : 0) + 
        State.ui.importanceFilters.length;
      
      const toggleBtn = document.getElementById('filtersToggleBtn');
      if (!toggleBtn) return;
      
      let badge = toggleBtn.querySelector('.filters-badge');
      
      if (activeFiltersCount > 0) {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'filters-badge';
          toggleBtn.appendChild(badge);
        }
        badge.textContent = activeFiltersCount;
      } else {
        if (badge) {
          badge.remove();
        }
      }
    }
  };

  // Expose App methods globally for onclick handlers
  window.App = App;

  // Initialize app when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => App.init());
  } else {
    App.init();
  }
})();
</script>
</body>
</html>